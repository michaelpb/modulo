<!DOCTYPE html>
<html>
<head>
    <meta charset="utf8" />
    <title>Source - Modulo.js</title>
    <link rel="stylesheet" media="all" href="../modified_parallel_docco.css" /> <!-- for doccu css -->
    <link rel="stylesheet" href="../../css/style.css" />
    <link rel="icon" type="image/png" href="../../img/mono_logo.png" />
    <script src="../../js/Modulo.js"></script>
    <mod-load namespace="mdu" src="../../components/core.html"></mod-load>
    <mod-load namespace="mdu" src="../../components/pageparts.html"></mod-load>
</head>

<body>
  <mdu-Navbar selected="source"></mdu-Navbar>
  <script>Modulo.defineAll();</script>

  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <h1 id="introduction">Introduction</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Welcome to the Modulo.js source code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* tl;dr: Modulo.globals is the same thing as &quot;window&quot; */</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> HTMLElement === <span class="hljs-string">&#x27;undefined&#x27;</span>) {
    <span class="hljs-keyword">var</span> HTMLElement = <span class="hljs-class"><span class="hljs-keyword">class</span> </span>{}; <span class="hljs-comment">// Node.js compatibilty</span>
}
<span class="hljs-keyword">var</span> globals = {HTMLElement};
<span class="hljs-keyword">var</span> Modulo = {globals};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p><strong>Unlike most code files, this one is arranged in a very deliberate way.</strong>
It’s arranged in a top-down manner, reflecting the lifecycle of a Modulo
component, such that the earlier and more important code is at the top, and
later and less important code is at the bottom. Thus, it is written like a
linear “story” of how Modulo works. Modulo employs
<a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a>,
or interweaving Markdown-formatted comments on to tell this story, and using
a tool to extract all these comments for easy reading. Excluding this
documentation you are reading now, the Modulo source code remains under 1000
lines of code.</p>
<h2 id="quick-definitions">Quick definitions:</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <ul>
<li>Component - A discrete, re-usable bit of code, typically used to show a
graphical UI element (eg a button, or a rich-text area). Components can
also use other components (eg a form).</li>
<li>ComponentPart, or CPart - Each component consists of a “bag” or “bundle”
of CParts, each CPart being a “pluggable” module that supplies different
functionality for that component.</li>
<li>customElement - The term used for a custom HTML5 web component</li>
<li>Modulo.globals - Identical to “window”, helps keep unit-tests simpler</li>
</ul>
<h2 id="modulodefineall">Modulo.defineAll()</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Our Modulo journey begins with <code>Modulo.defineAll()</code>, the function invoked to
“activate” all of Modulo by defining the “mod-load” web component. This
constructs a Loader object for every <code>&lt;mod-load ...&gt;</code> tag it encounters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Modulo.defineAll = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defineAll</span>(<span class="hljs-params"></span>) </span>{
    Modulo.globals.customElements.define(<span class="hljs-string">&#x27;mod-load&#x27;</span>, Modulo.Loader);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <h1 id="moduloloader">Modulo.Loader</h1>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Once registered by <code>defineAll()</code>, the <code>Modulo.Loader</code> will do the rest of
the heavy lifting of fetching &amp; registering Modulo components.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Modulo.Loader = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Loader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HTMLElement</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <h2 id="loader-connectedcallback">Loader: connectedCallback()</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>The Web Components specifies the use of a “connectedCallback” function.
In this case, this function will be invoked as soon as the DOM is loaded
with a <code>&lt;mod-load&gt;</code> tag in it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">connectedCallback</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.src = <span class="hljs-built_in">this</span>.getAttribute(<span class="hljs-string">&#x27;src&#x27;</span>);
        <span class="hljs-built_in">this</span>.initialize(<span class="hljs-built_in">this</span>.getAttribute(<span class="hljs-string">&#x27;namespace&#x27;</span>), Modulo.utils.parseAttrs(<span class="hljs-built_in">this</span>));
        <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Check if already loaded via a global / static serialized obj */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>After initializing data, send a new request to the URL specified by
the src attribute. When the response is received, load the text as a
Modulo component module definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Modulo.globals.fetch(<span class="hljs-built_in">this</span>.src)
            .then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.text())
            .then(<span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> <span class="hljs-built_in">this</span>.loadString(text));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <h2 id="loader-loadstring">Loader: loadString</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>The main loading method. This will take a string with the source code to
a module as an argument and loop through all <code>&lt;component ...&gt;</code> style
definitions. Then, it uses <code>Loader.loadFromDOMElement</code> to create a
<code>ComponentFactory</code> instance for each component definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">loadString</span>(<span class="hljs-params">text, alsoRegister=<span class="hljs-literal">true</span></span>)</span> {
        <span class="hljs-comment">/* TODO - Maybe use DOMParser here instead */</span>
        <span class="hljs-keyword">const</span> frag = <span class="hljs-keyword">new</span> Modulo.globals.DocumentFragment();
        <span class="hljs-keyword">const</span> div = Modulo.globals.document.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);
        div.innerHTML = text;
        frag.append(div);
        <span class="hljs-keyword">const</span> results = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tag <span class="hljs-keyword">of</span> div.querySelectorAll(<span class="hljs-string">&#x27;[mod-component],component&#x27;</span>)) {
            <span class="hljs-keyword">const</span> componentFactory = <span class="hljs-built_in">this</span>.loadFromDOMElement(tag);
            results.push(componentFactory);
            <span class="hljs-keyword">if</span> (alsoRegister) {
                componentFactory.register();
            }
        }
        <span class="hljs-keyword">return</span> results;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <h2 id="loader-loadfromdomelement">Loader: loadFromDOMElement</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Create a ComponentFactory instance from a given <code>&lt;component&gt;</code> definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">loadFromDOMElement</span>(<span class="hljs-params">elem</span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <h3 id="step-1-config">Step 1: Config</h3>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>Get any custom component configuration (e.g. attributes <code>name=</code> or
<code>extends=</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> attrs = Modulo.utils.parseAttrs(elem);
        <span class="hljs-keyword">const</span> name = attrs.modComponent || attrs.name;
        <span class="hljs-comment">/* Untested <span class="hljs-doctag">TODO:</span> Change this.componentFactoryData to be a map, also,
                 refactor this mess in general
        const extend = attrs[&#x27;extends&#x27;];
        if (extend) {
            for (const [name, data] of this.componentFactoryData) {
                if (name === extend) {
                    for (const key of Object.keys(data)) {
                        loadingObj[name] = [data[key]];
                    }
                }
            }
        }
        */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <h3 id="step-2-set-up-loadingobj">Step 2: Set-up <code>loadingObj</code></h3>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>Modulo often uses plain objects to “pass around” during the lifecycle
of each component. At this stage, we set up <code>loadingObj</code>.</p>
<p>At the end of this method, the loadingObj will be populated with a
complete, parsed, component definition – enough information to
instantiate a “factory” for this component – in the following
structure:</p>
<pre><code class="language-javascript">loadingObj = {
    <span class="hljs-attr">template</span>: [...], <span class="hljs-comment">// array of parsed objects for &quot;Template&quot; CPart</span>
    <span class="hljs-attr">state</span>: [...], <span class="hljs-comment">// array of parsed objects for &quot;State&quot; CPart</span>
    ...etc
}
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> loadingObj = {};
        loadingObj.component = [{name}]; <span class="hljs-comment">// Everything gets implicit Component CPart</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <h3 id="step-3-define-cparts">Step 3: define CParts</h3>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>Loop through each CPart DOM definition within the component (e.g.
<code>&lt;state&gt;</code>), invoking the <code>loadCallback</code> on each definition (e.g.
<code>Modulo.cparts.State.loadCallback</code> will get invoked for each
<code>&lt;state&gt;</code>). This <code>loadCallback</code> in turn will do any pre-processing
necessary to transform the attributes of the DOM element into the
data necessary to define this CPart.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> {cPartName, node} <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.getCPartNamesFromDOM(elem)) {
            <span class="hljs-keyword">const</span> cPart = Modulo.cparts.get(cPartName);
            <span class="hljs-keyword">const</span> results = cPart.loadCallback(node, <span class="hljs-built_in">this</span>, loadingObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Multiple parts of the same type, push onto array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (cPart.name <span class="hljs-keyword">in</span> loadingObj) {
                loadingObj[cPart.name].push(results);
            } <span class="hljs-keyword">else</span> {
                loadingObj[cPart.name] = [results];
            }
        }

        <span class="hljs-built_in">this</span>.componentFactoryData.push([name, loadingObj]);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.defineComponent(name, loadingObj);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <h2 id="loader-definecomponent">Loader: defineComponent</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>Helper function that constructs a new ComponentFactory for a component,
based on a loadingObj data structure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">defineComponent</span>(<span class="hljs-params">name, loadingObj</span>)</span> {
        <span class="hljs-keyword">const</span> factory = <span class="hljs-keyword">new</span> Modulo.ComponentFactory(<span class="hljs-built_in">this</span>, name, loadingObj);
        <span class="hljs-keyword">if</span> (Modulo.globals.defineComponentCallback) {
            Modulo.globals.defineComponentCallback(factory); <span class="hljs-comment">// TODO rm when possible</span>
        }
        <span class="hljs-keyword">return</span> factory;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <h2 id="loadergetnodecpartname">Loader.getNodeCPartName</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>Helper function that determines the CPart name from a DOM node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">getNodeCPartName</span>(<span class="hljs-params">node</span>)</span> {
        <span class="hljs-keyword">const</span> {tagName, nodeType, textContent} = node;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>node.nodeType equals 1 if the node is a DOM element (as opposed to
text, or comment). Ignore comments, tolerate empty text nodes, but
warn on others (since those are typically syntax mistakes).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (nodeType !== <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p>Text nodes, comment nodes, etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (nodeType === <span class="hljs-number">3</span> &amp;&amp; textContent &amp;&amp; textContent.trim()) {
                <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;Unexpected text in component def:&#x27;</span>, textContent);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p>Determine the name: The tag name, or the type attribute in the case
of the alt script-tag syntax (eg <code>&lt;script type=&quot;modulo/template&quot;&gt;</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> cPartName = tagName.toLowerCase();
        <span class="hljs-keyword">const</span> splitType = (node.getAttribute(<span class="hljs-string">&#x27;type&#x27;</span>) || <span class="hljs-string">&#x27;&#x27;</span>).split(<span class="hljs-string">&#x27;/&#x27;</span>);
        <span class="hljs-keyword">if</span> (splitType[<span class="hljs-number">0</span>] &amp;&amp; splitType[<span class="hljs-number">0</span>].toLowerCase() === <span class="hljs-string">&#x27;modulo&#x27;</span>) {
            cPartName = splitType[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">if</span> (!(Modulo.cparts.has(cPartName))) {
            <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;Unknown CPart in component def:&#x27;</span>, tagName);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> cPartName;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <h2 id="loadergetcpartnamesfromdom">Loader.getCPartNamesFromDOM</h2>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>Helper function that loops through a component definitions children,
generating an array of objects containing the node and CPart name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">getCPartNamesFromDOM</span>(<span class="hljs-params">elem</span>)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.from(elem.content.childNodes)
            .map(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> ({node, <span class="hljs-attr">cPartName</span>: <span class="hljs-built_in">this</span>.getNodeCPartName(node)}))
            .filter(<span class="hljs-function"><span class="hljs-params">obj</span> =&gt;</span> obj.cPartName);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <h2 id="loader-constructor-initialize">Loader: constructor, initialize</h2>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p>Constructor functions to get initial / default data set-up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">...args</span>)</span> {
        <span class="hljs-built_in">super</span>();
        <span class="hljs-built_in">this</span>.initialize.apply(<span class="hljs-built_in">this</span>, args);
    }

    <span class="hljs-function"><span class="hljs-title">initialize</span>(<span class="hljs-params">namespace, options, factoryData=<span class="hljs-literal">null</span></span>)</span> {
        <span class="hljs-built_in">this</span>.namespace = namespace;
        <span class="hljs-built_in">this</span>.customizedSettings = options;
        <span class="hljs-built_in">this</span>.settings = <span class="hljs-built_in">Object</span>.assign({}, options);
        <span class="hljs-built_in">this</span>.componentFactoryData = factoryData || [];
        <span class="hljs-built_in">this</span>.loadAll();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <h2 id="loader-loadall-serialize">Loader: loadAll, serialize</h2>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p>Utility functions used for serializing / deserializing a set of Modulo
component definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">loadAll</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [name, options] <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.componentFactoryData) {
            <span class="hljs-built_in">this</span>.defineComponent(name, options);
        }
    }

    <span class="hljs-function"><span class="hljs-title">serialize</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-comment">/* Note: Will probably rewrite thsi when working on &quot;modulo-cli build&quot;*/</span>
        <span class="hljs-keyword">const</span> arg0 = <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">this</span>.namespace);
        <span class="hljs-keyword">const</span> arg1 = <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">this</span>.customizedSettings);
        <span class="hljs-keyword">const</span> arg2 = <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">this</span>.componentFactoryData);
        <span class="hljs-keyword">return</span> <span class="hljs-string">`new Modulo.Loader(<span class="hljs-subst">${arg0}</span>, <span class="hljs-subst">${arg1}</span>, <span class="hljs-subst">${arg2}</span>);`</span>;
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <h1 id="modulocomponentfactory">Modulo.ComponentFactory</h1>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p>Now that we have traversed the jungle of loading Modulo component definitions,
what happens next? Well, for each component is defined, a ComponentFactory
instance is created. This class enables instantiating and setting up components
whenever they are encountered on an HTML page.</p>
<p>In Modulo, each component definition can be thought of as a collection of
CPart configurations. Thus, the ComponentFactory stores the configuration of
the CParts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Modulo.ComponentFactory = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ComponentFactory</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <h2 id="componentfactory-constructor">ComponentFactory constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <p>When a ComponentFactory gets constructed (that is, by the Loader), it in
turn sets up expected properties, and then invokes its methods
createClass and runFactoryLifeCycle explained next.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">loader, name, options</span>)</span> {
        Modulo.assert(name, <span class="hljs-string">&#x27;Name must be given.&#x27;</span>);
        <span class="hljs-built_in">this</span>.loader = loader;
        <span class="hljs-built_in">this</span>.options = options;
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.fullName = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">this</span>.loader.namespace}</span>-<span class="hljs-subst">${name}</span>`</span>;
        Modulo.ComponentFactory.registerInstance(<span class="hljs-built_in">this</span>);
        <span class="hljs-built_in">this</span>.componentClass = <span class="hljs-built_in">this</span>.createClass();
        <span class="hljs-built_in">this</span>.runFactoryLifecycle(options);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <h2 id="componentfactory-factory-lifecycle">ComponentFactory: Factory lifecycle</h2>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <p>This “factory” lifecycle is a special lifecycle for any global or one-time
setup, after component definitions are loaded, but before before any
components are constructed. Examples: the Style CPart uses this stage to
set up global CSS, the Template CPart uses this to compile the template,
and the Script CPart will actually wrap the script-tag &amp; invoke it now.</p>
<p>Like every other “lifecycle” in Modulo, it passes around a “renderObj”
called baseRenderObj. After this method, this baseRenderObj is not
modified, but instead gets copied into every other renderObj to form, as
the name implies, the “base” of future renderObj.</p>
<p>In total, this method loops through all the CPart names, finding each
relevant CPart Classes, and then invoking each CPart static method
“factoryCallback”, which is what does the necessary preprocessing. If
there are multiples of the same CPart, then whichever appears last will
overwrite and/or merge data with the previous ones.  However, that
particular behavior can be controlled from within each CPart
factoryCallback itself.</p>
<p>At the end of this method, baseRenderObj will look like this:</p>
<pre><code class="language-javascript"><span class="hljs-built_in">this</span>.baseRenderObj = {
    <span class="hljs-attr">script</span>: {<span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;&quot;use static&quot;\nvar state;\nfunction inpCh(....etc)&#x27;</span>},
    <span class="hljs-attr">template</span>: {<span class="hljs-attr">compiledTemplate</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ ...etc... }},
    (...etc...)
}
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">runFactoryLifecycle</span>(<span class="hljs-params">cPartOpts</span>)</span> {
        <span class="hljs-built_in">this</span>.baseRenderObj = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [partName, partOptionsArr] <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.entries(cPartOpts)) {
            <span class="hljs-keyword">const</span> cPart = Modulo.cparts.get(partName);
            <span class="hljs-keyword">let</span> data = {};
            <span class="hljs-keyword">for</span> (data <span class="hljs-keyword">of</span> partOptionsArr) {
                data = cPart.factoryCallback(data, <span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.baseRenderObj) || data;
            }
            <span class="hljs-built_in">this</span>.baseRenderObj[cPart.name] = data;
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <h2 id="componentfactory-createclass">ComponentFactory: createClass</h2>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <p>Finally, we are ready to create the class that the browser will use to
actually instantiate each Component. At this stage, we set up the
reconciliation engine, since that’s a component-wide option, create a
“back reference” to the factory from the component, and then return a
brand-new class definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">createClass</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">const</span> {fullName} = <span class="hljs-built_in">this</span>;
        <span class="hljs-keyword">const</span> {reconciliationEngine = <span class="hljs-string">&#x27;setdom&#x27;</span>} = <span class="hljs-built_in">this</span>.options;
        <span class="hljs-keyword">const</span> reconcile = Modulo.adapters.reconciliation[reconciliationEngine]();
        <span class="hljs-keyword">return</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomElement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Modulo</span>.<span class="hljs-title">Element</span> </span>{
            <span class="hljs-keyword">get</span> <span class="hljs-title">factory</span>() {
                <span class="hljs-comment">/* Gets current registered component factory (for hot-reloading) */</span>
                <span class="hljs-keyword">return</span> Modulo.ComponentFactory.instances.get(fullName);
            }
            <span class="hljs-keyword">get</span> <span class="hljs-title">reconcile</span>() { <span class="hljs-keyword">return</span> reconcile; }
        };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <h2 id="componentfactory-getcparts-register-instances--registerinstance">ComponentFactory: getCParts, register, instances &amp; registerInstance</h2>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-44">&#x00a7;</a>
              </div>
              <p>These are minor helper functions. The first rearranges the options data,
the second registers with window.customElements, and the third keeps a
central location for every ComponentFactory instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">getCParts</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">const</span> results = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [partName, partOptionsArr] <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.entries(<span class="hljs-built_in">this</span>.options)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> partOptions <span class="hljs-keyword">of</span> partOptionsArr) {
                <span class="hljs-keyword">const</span> cPart = Modulo.cparts.get(partName);
                Modulo.assert(cPart, <span class="hljs-string">`Unknown cPart: <span class="hljs-subst">${partName}</span>`</span>);
                results.push({cPart, partOptions});
            }
        }
        <span class="hljs-keyword">return</span> results;
    }
    <span class="hljs-function"><span class="hljs-title">register</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">const</span> tagName = <span class="hljs-built_in">this</span>.fullName.toLowerCase();
        Modulo.globals.customElements.define(tagName, <span class="hljs-built_in">this</span>.componentClass);
    }
    <span class="hljs-keyword">static</span> instances = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">registerInstance</span>(<span class="hljs-params">instance</span>)</span> {
        Modulo.ComponentFactory.instances.set(instance.fullName, instance);
    }
}

Modulo.Element = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModuloElement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HTMLElement</span> </span>{
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">super</span>();
        <span class="hljs-built_in">this</span>.componentParts = [];
        <span class="hljs-comment">/*
        console.log(&#x27;this is this&#x27;, this);
        console.log(&#x27;this is this&#x27;, this.getAttribute);
        */</span>
        <span class="hljs-built_in">this</span>.originalHTML = <span class="hljs-built_in">this</span>.innerHTML;

        <span class="hljs-built_in">this</span>.originalChildren = [];
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.hasChildNodes()) {
            <span class="hljs-keyword">const</span> dupedChildren = <span class="hljs-built_in">Array</span>.from(<span class="hljs-built_in">this</span>.childNodes); <span class="hljs-comment">// necessary</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> child <span class="hljs-keyword">of</span> dupedChildren) {
                <span class="hljs-built_in">this</span>.originalChildren.push(<span class="hljs-built_in">this</span>.removeChild(child));
            }
        }
        <span class="hljs-built_in">this</span>.initialize();
    }

    <span class="hljs-function"><span class="hljs-title">initialize</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.name = <span class="hljs-string">&#x27;element&#x27;</span>; <span class="hljs-comment">// Used by lifecycle // <span class="hljs-doctag">TODO:</span> Replace with lifecycleName</span>
        <span class="hljs-built_in">this</span>.fullName = <span class="hljs-built_in">this</span>.factory.fullName;
        <span class="hljs-built_in">this</span>.isMounted = <span class="hljs-literal">false</span>;
        <span class="hljs-built_in">this</span>.isModuloElement = <span class="hljs-literal">true</span>; <span class="hljs-comment">// used when finding parent</span>
        <span class="hljs-built_in">this</span>.initRenderObj = <span class="hljs-built_in">Object</span>.assign({}, <span class="hljs-built_in">this</span>.factory.baseRenderObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-45">&#x00a7;</a>
              </div>
              <p>this.initRenderObj = new Modulo.TaggedObjectMap(this.factory.baseRenderObj);
this.cparts = new Modulo.TaggedObjectMap();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    <span class="hljs-function"><span class="hljs-title">constructParts</span>(<span class="hljs-params">isReload=<span class="hljs-literal">false</span></span>)</span> {
        <span class="hljs-keyword">const</span> oldCParts = isReload ? <span class="hljs-built_in">this</span>.componentParts : [];
        <span class="hljs-built_in">this</span>.componentParts = [<span class="hljs-built_in">this</span>]; <span class="hljs-comment">// Include self, to hook into lifecycle</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> {cPart, partOptions} <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.factory.getCParts()) {
            <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> cPart(<span class="hljs-built_in">this</span>, partOptions);
            <span class="hljs-built_in">this</span>.componentParts.push(instance);

            <span class="hljs-keyword">if</span> (instance.reloadCallback) {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-46">&#x00a7;</a>
              </div>
              <p>Trigger any custom reloading code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">const</span> oldPart = oldCParts.find(<span class="hljs-function">(<span class="hljs-params">{name}</span>) =&gt;</span> name === cPart.name);
                <span class="hljs-keyword">if</span> (oldPart) {
                    instance.reloadCallback(oldPart);
                }
            }
        }
    }

    <span class="hljs-function"><span class="hljs-title">getPart</span>(<span class="hljs-params">searchName</span>)</span> {
        <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Maybe should refactor this? Shouldn&#x27;t be used much... */</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.componentParts.find(<span class="hljs-function">(<span class="hljs-params">{name}</span>) =&gt;</span> name === searchName);
    }

    <span class="hljs-function"><span class="hljs-title">applyDirectives</span>(<span class="hljs-params">directives</span>)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> args <span class="hljs-keyword">of</span> directives) {
            <span class="hljs-keyword">const</span> {setUp, tearDown, el, rawName, hasRun, value, dName} = args;
            <span class="hljs-keyword">if</span> (!setUp) {
                <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;TMP Skipping:&#x27;</span>, dName, rawName, value);
                <span class="hljs-keyword">continue</span>;
            }
            args.resolutionContext = <span class="hljs-built_in">this</span>; <span class="hljs-comment">// TODO fix this with truly predictable context</span>
            <span class="hljs-keyword">if</span> (hasRun) {
                <span class="hljs-keyword">if</span> (!tearDown) {
                    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;TMP NO TEAR DOWN ERR:&#x27;</span>, rawName);
                }
                tearDown(args);
            }
            args.hasRun = <span class="hljs-literal">true</span>;
            setUp(args);
            <span class="hljs-comment">/*
            if (setUp) {
                el.onload = setUp.bind(thisContext, [args]);
            }
            if (tearDown) {
                el.onunload = tearDown.bind(thisContext, [args]);
            }
            */</span>
        }
    }

    <span class="hljs-function"><span class="hljs-title">rerender</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.lifecycle([<span class="hljs-string">&#x27;prepare&#x27;</span>, <span class="hljs-string">&#x27;render&#x27;</span>, <span class="hljs-string">&#x27;update&#x27;</span>, <span class="hljs-string">&#x27;updated&#x27;</span>]);
    }

    <span class="hljs-function"><span class="hljs-title">lifecycle</span>(<span class="hljs-params">lifecycleNames</span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-47">&#x00a7;</a>
              </div>
              <p>NEW CODE: This is a quick re-implementation of lifecycle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">this</span>.renderObj = <span class="hljs-built_in">Object</span>.assign({}, <span class="hljs-built_in">this</span>.getCurrentRenderObj());</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-48">&#x00a7;</a>
              </div>
              <p>todo: maybe sort cparts ahead of time based on lifecycles?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> lcName <span class="hljs-keyword">of</span> lifecycleNames) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> cPart <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.componentParts) {
                <span class="hljs-keyword">const</span> method = cPart[lcName + <span class="hljs-string">&#x27;Callback&#x27;</span>];
                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.renderObj) {
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;lolwut - renderobj is falsy&#x27;</span>, <span class="hljs-built_in">this</span>.renderObj);
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">if</span> (!(cPart.name <span class="hljs-keyword">in</span> <span class="hljs-built_in">this</span>.renderObj)) {
                    <span class="hljs-built_in">this</span>.renderObj[cPart.name] = cPart;
                }
                <span class="hljs-keyword">if</span> (method) {
                    <span class="hljs-keyword">const</span> results = method.call(cPart, <span class="hljs-built_in">this</span>.renderObj);
                    <span class="hljs-keyword">if</span> (results) {
                        <span class="hljs-built_in">this</span>.renderObj[cPart.name] = results;
                    }
                }
            }
        }
        <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> should probably be nulling this after */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-49">&#x00a7;</a>
              </div>
              <p>this.renderObj = null; // rendering is over, set to null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    <span class="hljs-function"><span class="hljs-title">getCurrentRenderObj</span>(<span class="hljs-params"></span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-50">&#x00a7;</a>
              </div>
              <p>console.log(‘this is initRenderObj’, this.initRenderObj);
console.log(‘this is renderObj’, this.renderObj);
console.log(‘this is eventRenderObj’, this.eventRenderObj);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.eventRenderObj || <span class="hljs-built_in">this</span>.renderObj || <span class="hljs-built_in">this</span>.initRenderObj);
    }

    <span class="hljs-function"><span class="hljs-title">resolveValue</span>(<span class="hljs-params">key</span>)</span> {
        <span class="hljs-keyword">const</span> rObj = <span class="hljs-built_in">this</span>.getCurrentRenderObj();
        <span class="hljs-keyword">const</span> hackName = <span class="hljs-built_in">this</span>.factory.name;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-51">&#x00a7;</a>
              </div>
              <p>console.log(<code>   ${hackName} -- GET   ${key}</code>, rObj);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> result = key.split(<span class="hljs-string">&#x27;.&#x27;</span>).reduce(<span class="hljs-function">(<span class="hljs-params">o, name</span>) =&gt;</span> o[name], rObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-52">&#x00a7;</a>
              </div>
              <p>console.log(<code>   ${hackName} -- VALUE ${key} &lt;&lt;${result}&gt;&gt;</code>);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-function"><span class="hljs-title">resolveAttributeName</span>(<span class="hljs-params">name</span>)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.hasAttribute(name)) {
            <span class="hljs-keyword">return</span> name;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.hasAttribute(name + <span class="hljs-string">&#x27;:&#x27;</span>)) {
            <span class="hljs-keyword">return</span> name + <span class="hljs-string">&#x27;:&#x27;</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-function"><span class="hljs-title">connectedCallback</span>(<span class="hljs-params"></span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-53">&#x00a7;</a>
              </div>
              <p>Note: For testability, constructParts is invoked on first mount,
before initialize.  This is so the hacky “fake-upgrade” for custom
components works for the automated tests. Logically, it should
probably be invoked in the constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">this</span>.constructParts();
        <span class="hljs-built_in">this</span>.lifecycle([<span class="hljs-string">&#x27;initialized&#x27;</span>])
        <span class="hljs-built_in">this</span>.rerender();
        <span class="hljs-built_in">this</span>.isMounted = <span class="hljs-literal">true</span>;
    }
}

Modulo.collectDirectives = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">collectDirectives</span>(<span class="hljs-params">component, el, arr</span>) </span>{
    <span class="hljs-keyword">if</span> (!arr) {
        arr = []; <span class="hljs-comment">// HACK for testability</span>
    }
    <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> for &quot;pre-load&quot; directives, possibly just pass in &quot;Loader&quot; as
       &quot;component&quot; so we can have load-time directives */</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rawName <span class="hljs-keyword">of</span> el.getAttributeNames()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-54">&#x00a7;</a>
              </div>
              <p>todo: optimize skipping most elements or attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> name = rawName;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [regexp, dir] <span class="hljs-keyword">of</span> Modulo.directiveShortcuts) {
            <span class="hljs-keyword">if</span> (rawName.match(regexp)) {
                name = <span class="hljs-string">`[<span class="hljs-subst">${dir}</span>]`</span> + name.replace(regexp, <span class="hljs-string">&#x27;&#x27;</span>);
            }
        }
        <span class="hljs-keyword">if</span> (!name.startsWith(<span class="hljs-string">&#x27;[&#x27;</span>)) {
            <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// There are no directives, skip</span>
        }
        <span class="hljs-keyword">const</span> value = el.getAttribute(rawName);
        <span class="hljs-keyword">const</span> attrName = cleanWord((name.match(<span class="hljs-regexp">/\][^\]]+$/</span>) || [<span class="hljs-string">&#x27;&#x27;</span>])[<span class="hljs-number">0</span>]);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dName <span class="hljs-keyword">of</span> name.split(<span class="hljs-string">&#x27;]&#x27;</span>).map(cleanWord)) {
            <span class="hljs-keyword">if</span> (dName === attrName) {
                <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// Skip bare name</span>
            }
            <span class="hljs-keyword">const</span> setUp = component.resolveValue(dName + <span class="hljs-string">&#x27;Mount&#x27;</span>);
            <span class="hljs-keyword">const</span> tearDown = component.resolveValue(dName + <span class="hljs-string">&#x27;Unmount&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-55">&#x00a7;</a>
              </div>
              <p>console.log(‘dName’, dName, attrName, component);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Modulo.assert(setUp || tearDown, <span class="hljs-string">`Unknown directive: &quot;<span class="hljs-subst">${dName}</span>&quot;`</span>);
            arr.push({el, value, attrName, rawName, setUp, tearDown, dName})
        }
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> child <span class="hljs-keyword">of</span> el.children) {</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-56">&#x00a7;</a>
              </div>
              <p>tail recursion into children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Modulo.collectDirectives(component, child, arr);
    }
    <span class="hljs-keyword">return</span> arr; <span class="hljs-comment">// HACK for testability</span>
}

Modulo.cparts = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
Modulo.directiveShortcuts = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
Modulo.directiveShortcuts.set(<span class="hljs-regexp">/^@/</span>, <span class="hljs-string">&#x27;component.event&#x27;</span>);
Modulo.directiveShortcuts.set(<span class="hljs-regexp">/:$/</span>, <span class="hljs-string">&#x27;component.resolve&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-57">&#x00a7;</a>
              </div>
              <p>Modulo.directiveShortcuts.set(/.$/, ‘json’); // idea for JSON literals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Modulo.adapters = {
    <span class="hljs-attr">templating</span>: {
        <span class="hljs-attr">ModuloTemplate</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> <span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> <span class="hljs-keyword">new</span> Modulo.Template(text).render(ctx),
    },
    <span class="hljs-attr">reconciliation</span>: {
        <span class="hljs-attr">none</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-function">(<span class="hljs-params">component, html</span>) =&gt;</span> {
            component.innerHTML = html;
        },
        <span class="hljs-attr">setdom</span>: <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Maybe, move into function, so instantiate each time?? */</span>
            <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">component, html</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> reconciler = <span class="hljs-keyword">new</span> Modulo.SetDomReconciler();
                reconciler.reconcile(component, html);
            };
        },
        <span class="hljs-attr">morphdom</span>: <span class="hljs-function">() =&gt;</span> {
            Modulo.assert(Modulo.globals.morphdom, <span class="hljs-string">&#x27;morphdom is not loaded at window.morphdom&#x27;</span>);
            <span class="hljs-keyword">const</span> {morphdom} = Modulo.globals;
            <span class="hljs-keyword">const</span> opts = {
                <span class="hljs-attr">getNodeKey</span>: <span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> el.getAttribute &amp;&amp; el.getAttribute(<span class="hljs-string">&#x27;key&#x27;</span>),
                <span class="hljs-attr">onBeforeElChildrenUpdated</span>: <span class="hljs-function">(<span class="hljs-params">fromEl, toEl</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-58">&#x00a7;</a>
              </div>
              <p>TODO: Possibly add directives here-ish</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">return</span> !toEl.tagName.includes(<span class="hljs-string">&#x27;-&#x27;</span>);
                },
                <span class="hljs-attr">childrenOnly</span>: <span class="hljs-literal">true</span>,
            };
            <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">component, html</span>) =&gt;</span> {
                <span class="hljs-keyword">if</span> (!component.isMounted) {
                    component.innerHTML = html;
                } <span class="hljs-keyword">else</span> {
                    morphdom(component, <span class="hljs-string">`&lt;div&gt;<span class="hljs-subst">${html}</span>&lt;/div&gt;`</span>, opts);
                }
            };
        },
    },
};


Modulo.ComponentPart = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ComponentPart</span> </span>{
    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">loadCallback</span>(<span class="hljs-params">node, loader, loadingObj</span>)</span> {
        <span class="hljs-keyword">const</span> options = Modulo.utils.parseAttrs(node);
        <span class="hljs-keyword">const</span> content = node.tagName === <span class="hljs-string">&#x27;TEMPLATE&#x27;</span> ? node.innerHTML
                                                    : node.textContent;
        <span class="hljs-keyword">return</span> {options, content};
    }

    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">factoryCallback</span>(<span class="hljs-params"></span>)</span> {}

    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">component, options</span>)</span> {
        <span class="hljs-built_in">this</span>.component = component; <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Change to this.element</span>
        <span class="hljs-built_in">this</span>.options = options.options;
        <span class="hljs-built_in">this</span>.content = options.content;
    }

    <span class="hljs-keyword">get</span> <span class="hljs-title">name</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.constructor.name;
    }
}

Modulo.parts = {};
Modulo.parts.Component = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Component</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Modulo</span>.<span class="hljs-title">ComponentPart</span> </span>{
    <span class="hljs-keyword">static</span> name = <span class="hljs-string">&#x27;component&#x27;</span>;
    <span class="hljs-function"><span class="hljs-title">prepareCallback</span>(<span class="hljs-params"></span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-59">&#x00a7;</a>
              </div>
              <p>TODO shouldn’t have to do this —v</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">eventMount</span>: <span class="hljs-built_in">this</span>.eventMount.bind(<span class="hljs-built_in">this</span>),
            <span class="hljs-attr">eventUnmount</span>: <span class="hljs-built_in">this</span>.eventUnmount.bind(<span class="hljs-built_in">this</span>),
            <span class="hljs-attr">resolveMount</span>: <span class="hljs-built_in">this</span>.resolveMount.bind(<span class="hljs-built_in">this</span>),
            <span class="hljs-attr">resolveUnmount</span>: <span class="hljs-built_in">this</span>.resolveUnmount.bind(<span class="hljs-built_in">this</span>),
            <span class="hljs-attr">childrenMount</span>: <span class="hljs-built_in">this</span>.childrenMount.bind(<span class="hljs-built_in">this</span>),
            <span class="hljs-attr">childrenUnmount</span>: <span class="hljs-built_in">this</span>.childrenUnmount.bind(<span class="hljs-built_in">this</span>),
        };
    }

    <span class="hljs-function"><span class="hljs-title">updateCallback</span>(<span class="hljs-params">renderObj</span>)</span> {
        <span class="hljs-keyword">const</span> {component} = <span class="hljs-built_in">this</span>;
        <span class="hljs-keyword">let</span> newContents = (renderObj.template || {}).renderedOutput || <span class="hljs-string">&#x27;&#x27;</span>;
        component.reconcile(component, newContents);
    }

    <span class="hljs-function"><span class="hljs-title">handleEvent</span>(<span class="hljs-params">func, ev, payload</span>)</span> {
        <span class="hljs-built_in">this</span>.component.lifecycle([<span class="hljs-string">&#x27;event&#x27;</span>]);
        func.call(<span class="hljs-literal">null</span>, ev, payload); <span class="hljs-comment">// todo: bind to array.push etc, or get autobinding in resolveValue</span>
        <span class="hljs-built_in">this</span>.component.lifecycle([<span class="hljs-string">&#x27;eventCleanup&#x27;</span>]);
    }

    <span class="hljs-function"><span class="hljs-title">childrenMount</span>(<span class="hljs-params">{el}</span>)</span> {
        el.append(...this.component.originalChildren);
        <span class="hljs-built_in">this</span>.component.originalChildren = [];
    }

    <span class="hljs-function"><span class="hljs-title">childrenUnmount</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.component.innerHTML = <span class="hljs-string">&#x27;&#x27;</span>;
    }

    <span class="hljs-function"><span class="hljs-title">eventMount</span>(<span class="hljs-params">info</span>)</span> {
        <span class="hljs-keyword">const</span> {el, value, attrName, rawName} = info;
        <span class="hljs-keyword">const</span> getAttr = getGetAttr(el);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-60">&#x00a7;</a>
              </div>
              <p>console.log(‘this is eventMount’, info);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> listener = <span class="hljs-function">(<span class="hljs-params">ev</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-61">&#x00a7;</a>
              </div>
              <p>window.C = this;
console.log(‘this is rawName’, rawName, value);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">const</span> func = getAttr(attrName, getAttr(rawName));
            Modulo.assert(func, <span class="hljs-string">`Bad <span class="hljs-subst">${attrName}</span>, <span class="hljs-subst">${value}</span> is <span class="hljs-subst">${func}</span>`</span>);
            <span class="hljs-keyword">const</span> payload = getAttr(<span class="hljs-string">`<span class="hljs-subst">${attrName}</span>.payload`</span>, el.value);
            <span class="hljs-built_in">this</span>.handleEvent(func, ev, payload);
        };
        info.listener = listener;
        el.addEventListener(attrName, listener);
    }

    <span class="hljs-function"><span class="hljs-title">eventUnmount</span>(<span class="hljs-params">{attrName, listener}</span>)</span> {
        el.removeEventListener(attrName, listener);
    }

    <span class="hljs-function"><span class="hljs-title">resolveMount</span>(<span class="hljs-params">{el, value, attrName, resolutionContext}</span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-62">&#x00a7;</a>
              </div>
              <p>console.log(‘this is it’, resolutionContext);
console.log(‘this is resolve mount’, attrName, value);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> resolvedValue = resolutionContext.resolveValue(value);
        el.attrs = <span class="hljs-built_in">Object</span>.assign(el.attrs || {}, {[attrName]: resolvedValue});
        el.getAttr = <span class="hljs-function">(<span class="hljs-params">n, def</span>) =&gt;</span> {
            <span class="hljs-keyword">let</span> val;
            <span class="hljs-keyword">if</span> (n <span class="hljs-keyword">in</span> el.attrs) {
                val = el.attrs[n];
            } <span class="hljs-keyword">else</span> {
                val = el.getAttribute(n) || def;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-63">&#x00a7;</a>
              </div>
              <p>console.log(‘——————-‘, n, val);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> val;
        };
    }
    <span class="hljs-function"><span class="hljs-title">resolveUnmount</span>(<span class="hljs-params">{el, attrName}</span>)</span> {
        <span class="hljs-keyword">delete</span> el.attrs[attrName];
    }
}
Modulo.cparts.set(<span class="hljs-string">&#x27;component&#x27;</span>, Modulo.parts.Component);

Modulo.parts.Props = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Props</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Modulo</span>.<span class="hljs-title">ComponentPart</span> </span>{
    <span class="hljs-keyword">static</span> name = <span class="hljs-string">&#x27;props&#x27;</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">factoryCallback</span>(<span class="hljs-params">{options}, {componentClass}, renderObj</span>)</span> {
        <span class="hljs-comment">/* untested / daedcode ---v */</span>
        componentClass.observedAttributes = <span class="hljs-built_in">Object</span>.keys(options);
    }

    <span class="hljs-function"><span class="hljs-title">copyMount</span>(<span class="hljs-params">{el}</span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-64">&#x00a7;</a>
              </div>
              <p>dead code?
change to “this.element”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> attr <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.component.getAttributeNames()) {
            el.setAttribute(attr, <span class="hljs-built_in">this</span>.component.getAttribute(attr));
        }
        <span class="hljs-comment">/*
        const props = {};
        for (let propName of Object.keys(this.options)) {
            propName = propName.replace(/:$/, &#x27;&#x27;); // normalize
            let attrName = this.component.resolveAttributeName(propName);
            if (!attrName) {
                console.error(&#x27;Prop&#x27;, propName, &#x27;is required for&#x27;, this.component.tagName);
                continue;
            }
            let value = this.component.getAttribute(attrName);
            if (attrName.endsWith(&#x27;:&#x27;)) {
                attrName = attrName.slice(0, -1); // trim &#x27;:&#x27;
                value = this.component.moduloRenderContext.resolveValue(value);
            }
            props[propName] = value;
        }
        */</span>
    }

    <span class="hljs-function"><span class="hljs-title">initializedCallback</span>(<span class="hljs-params">renderObj</span>)</span> {
        <span class="hljs-keyword">const</span> props = {};
        <span class="hljs-keyword">const</span> getAttr = getGetAttr(<span class="hljs-built_in">this</span>.component);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> propName <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.options)) {
            propName = propName.replace(<span class="hljs-regexp">/:$/</span>, <span class="hljs-string">&#x27;&#x27;</span>); <span class="hljs-comment">// TODO, make func to normalize directives</span>
            props[propName] = getAttr(propName);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-65">&#x00a7;</a>
              </div>
              <p>console.log(‘this is props’, props);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> props;
    }
}
Modulo.cparts.set(<span class="hljs-string">&#x27;props&#x27;</span>, Modulo.parts.Props);

Modulo.parts.Style = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Style</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Modulo</span>.<span class="hljs-title">ComponentPart</span> </span>{
    <span class="hljs-keyword">static</span> name = <span class="hljs-string">&#x27;style&#x27;</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">factoryCallback</span>(<span class="hljs-params">{content}, factory, renderObj</span>)</span> {
        <span class="hljs-keyword">const</span> {fullName} = factory;
        <span class="hljs-keyword">const</span> id = <span class="hljs-string">`<span class="hljs-subst">${fullName}</span>_style`</span>;
        <span class="hljs-keyword">let</span> elem = Modulo.globals.document.getElementById(id);
        <span class="hljs-keyword">if</span> (!elem) {
            elem = Modulo.globals.document.createElement(<span class="hljs-string">&#x27;style&#x27;</span>);
            elem.id = id;
            Modulo.globals.document.head.append(elem)
        }
        elem.textContent = content;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">prefixAllSelectors</span>(<span class="hljs-params">namespace, name, text=<span class="hljs-string">&#x27;&#x27;</span></span>)</span> {
        <span class="hljs-keyword">const</span> fullName = <span class="hljs-string">`<span class="hljs-subst">${namespace}</span>-<span class="hljs-subst">${name}</span>`</span>;
        <span class="hljs-keyword">let</span> content = text.replace(<span class="hljs-regexp">/\*\/.*?\*\//ig</span>, <span class="hljs-string">&#x27;&#x27;</span>); <span class="hljs-comment">// strip comments</span>
        content = content.replace(<span class="hljs-regexp">/([^\r\n,{}]+)(,(?=[^}]*{)|\s*{)/gi</span>, <span class="hljs-function"><span class="hljs-params">selector</span> =&gt;</span> {
            selector = selector.trim();
            <span class="hljs-keyword">if</span> (selector.startsWith(<span class="hljs-string">&#x27;@&#x27;</span>) || selector.startsWith(fullName)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-66">&#x00a7;</a>
              </div>
              <p>Skip, is @media or @keyframes, or already prefixed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> selector;
            }
            selector = selector.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(name, <span class="hljs-string">&#x27;ig&#x27;</span>), fullName);
            <span class="hljs-keyword">if</span> (!selector.startsWith(fullName)) {
                selector = <span class="hljs-string">`<span class="hljs-subst">${fullName}</span> <span class="hljs-subst">${selector}</span>`</span>;
            }
            <span class="hljs-keyword">return</span> selector;
        });
        <span class="hljs-keyword">return</span> content;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">loadCallback</span>(<span class="hljs-params">node, loader, loadingObj</span>)</span> {
        <span class="hljs-keyword">let</span> {content, options} = <span class="hljs-built_in">super</span>.loadCallback(node, loader, loadingObj);
        <span class="hljs-keyword">const</span> {name} = loadingObj.component[<span class="hljs-number">0</span>];
        content = Modulo.parts.Style.prefixAllSelectors(loader.namespace, name, content);
        <span class="hljs-keyword">return</span> {options, content};
    }
}
Modulo.cparts.set(<span class="hljs-string">&#x27;style&#x27;</span>, Modulo.parts.Style);


Modulo.parts.Template = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Template</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Modulo</span>.<span class="hljs-title">ComponentPart</span> </span>{
    <span class="hljs-keyword">static</span> name = <span class="hljs-string">&#x27;template&#x27;</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">factoryCallback</span>(<span class="hljs-params">opts, factory, renderObj</span>)</span> {
        <span class="hljs-keyword">const</span> {loader} = factory;
        <span class="hljs-keyword">const</span> tagPref = <span class="hljs-string">&#x27;$1&#x27;</span> + loader.namespace + <span class="hljs-string">&#x27;-&#x27;</span>;
        <span class="hljs-keyword">const</span> content = (opts.content || <span class="hljs-string">&#x27;&#x27;</span>).replace(<span class="hljs-regexp">/(&lt;\/?)my-/ig</span>, tagPref);
        <span class="hljs-keyword">const</span> {templatingEngine = <span class="hljs-string">&#x27;ModuloTemplate&#x27;</span>} = (renderObj.template || {}).options || {};
        <span class="hljs-keyword">const</span> templateCompiler = Modulo.adapters.templating[templatingEngine]();
        <span class="hljs-keyword">const</span> compiledTemplate = templateCompiler(content, opts);
        <span class="hljs-keyword">return</span> {compiledTemplate};
    }
    <span class="hljs-function"><span class="hljs-title">renderCallback</span>(<span class="hljs-params">renderObj</span>)</span> {
        <span class="hljs-keyword">const</span> compiledTemplate = renderObj.template.compiledTemplate;
        <span class="hljs-keyword">const</span> context = renderObj;
        <span class="hljs-keyword">const</span> result = compiledTemplate(context);
        <span class="hljs-keyword">if</span> (result.includes(<span class="hljs-string">&#x27;undefined&#x27;</span>)) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;undefined me&#x27;</span>, renderObj);
        }
        <span class="hljs-keyword">return</span> {<span class="hljs-attr">renderedOutput</span>: result, compiledTemplate};
    }
}
Modulo.cparts.set(<span class="hljs-string">&#x27;template&#x27;</span>, Modulo.parts.Template);


Modulo.parts.Script = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Script</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Modulo</span>.<span class="hljs-title">ComponentPart</span> </span>{
    <span class="hljs-keyword">static</span> name = <span class="hljs-string">&#x27;script&#x27;</span>;

    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">getSymbolsAsObjectAssignment</span>(<span class="hljs-params">contents</span>)</span> {
        <span class="hljs-keyword">const</span> regexpG = <span class="hljs-regexp">/function\s+(\w+)/g</span>;
        <span class="hljs-keyword">const</span> regexp2 = <span class="hljs-regexp">/function\s+(\w+)/</span>; <span class="hljs-comment">// hack, refactor</span>
        <span class="hljs-keyword">const</span> matches = contents.match(regexpG) || [];
        <span class="hljs-keyword">return</span> matches.map(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.match(regexp2)[<span class="hljs-number">1</span>])
            .map(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> <span class="hljs-string">`&quot;<span class="hljs-subst">${s}</span>&quot;: typeof <span class="hljs-subst">${s}</span> !== &quot;undefined&quot; ? <span class="hljs-subst">${s}</span> : undefined,\n`</span>)
            .join(<span class="hljs-string">&#x27;&#x27;</span>);
    }

    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">wrapJavaScriptContext</span>(<span class="hljs-params">contents, localVars</span>)</span> {
        <span class="hljs-keyword">const</span> symbolsString = <span class="hljs-built_in">this</span>.getSymbolsAsObjectAssignment(contents);
        <span class="hljs-keyword">const</span> localVarsLet = localVars.join(<span class="hljs-string">&#x27;,&#x27;</span>) || <span class="hljs-string">&#x27;noLocalVars=true&#x27;</span>;
        <span class="hljs-keyword">const</span> localVarsIfs = localVars.map(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-string">`if (name === &#x27;<span class="hljs-subst">${n}</span>&#x27;) <span class="hljs-subst">${n}</span> = value;`</span>).join(<span class="hljs-string">&#x27;\n&#x27;</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">`
            &#x27;use strict&#x27;;
            var <span class="hljs-subst">${localVarsLet}</span>;
            var module = {exports: {}};
            function __set(name, value) { <span class="hljs-subst">${localVarsIfs}</span> }
            <span class="hljs-subst">${contents}</span>
            return { <span class="hljs-subst">${symbolsString}</span> setLocalVariable: __set, exports: module.exports};
        `</span>;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">factoryCallback</span>(<span class="hljs-params">partOptions, factory, renderObj</span>)</span> {
        <span class="hljs-keyword">const</span> code = partOptions.content || <span class="hljs-string">&#x27;&#x27;</span>;
        <span class="hljs-keyword">const</span> localVars = <span class="hljs-built_in">Object</span>.keys(renderObj);
        localVars.push(<span class="hljs-string">&#x27;element&#x27;</span>); <span class="hljs-comment">// add in element as a local var</span>
        localVars.push(<span class="hljs-string">&#x27;parent&#x27;</span>); <span class="hljs-comment">// add in access to previous versions of renderObj // <span class="hljs-doctag">TODO:</span> finish, currently dead code</span>
        <span class="hljs-keyword">const</span> wrappedJS = <span class="hljs-built_in">this</span>.wrapJavaScriptContext(code, localVars);
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">&#x27;Modulo&#x27;</span>, wrappedJS)).call(<span class="hljs-literal">null</span>, Modulo);
    }

    <span class="hljs-function"><span class="hljs-title">initializedCallback</span>(<span class="hljs-params">renderObj</span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-67">&#x00a7;</a>
              </div>
              <p>Make sure that the local variables are all properly set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> {setLocalVariable} = renderObj.script;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> part <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.component.componentParts) {
            setLocalVariable(part.name, part);
        }
        setLocalVariable(<span class="hljs-string">&#x27;element&#x27;</span>, <span class="hljs-built_in">this</span>.component);
    }

    <span class="hljs-function"><span class="hljs-title">eventCallback</span>(<span class="hljs-params">renderObj</span>)</span> {
        <span class="hljs-built_in">this</span>.initializedCallback(renderObj);
    }
}
Modulo.cparts.set(<span class="hljs-string">&#x27;script&#x27;</span>, Modulo.parts.Script);

Modulo.parts.State = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Modulo</span>.<span class="hljs-title">ComponentPart</span> </span>{
    <span class="hljs-keyword">static</span> name = <span class="hljs-string">&#x27;state&#x27;</span>;
    <span class="hljs-keyword">static</span> debugGhost = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">get</span> <span class="hljs-title">debugGhost</span>() { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
    <span class="hljs-function"><span class="hljs-title">initializedCallback</span>(<span class="hljs-params">renderObj</span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-68">&#x00a7;</a>
              </div>
              <p>console.log(‘initialized callback (1)’, this.data);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">this</span>.rawDefaults = renderObj.state.options || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-69">&#x00a7;</a>
              </div>
              <p>console.log(‘initialized callback (2)’, renderObj);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">this</span>.boundElements = {};
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.data) {
            <span class="hljs-built_in">this</span>.data = Modulo.utils.simplifyResolvedLiterals(<span class="hljs-built_in">this</span>.rawDefaults);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-70">&#x00a7;</a>
              </div>
              <p>console.log(‘initialized callback (3)’, this.data);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    <span class="hljs-function"><span class="hljs-title">bindMount</span>(<span class="hljs-params">{el}</span>)</span> {
        el.getAttr = el.getAttr || el.getAttribute;
        <span class="hljs-keyword">const</span> name = el.getAttr(<span class="hljs-string">&#x27;name&#x27;</span>);
        Modulo.assert(name <span class="hljs-keyword">in</span> <span class="hljs-built_in">this</span>.data, <span class="hljs-string">`[state.bind]: &quot;<span class="hljs-subst">${name}</span>&quot; not in state`</span>);
        <span class="hljs-keyword">const</span> func = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">this</span>.set(name, el.value);
        <span class="hljs-keyword">const</span> evName = <span class="hljs-string">&#x27;keyup&#x27;</span>; <span class="hljs-comment">// eventually customizable</span>
        <span class="hljs-built_in">this</span>.boundElements[name] = [el, evName, func];
        el.value = <span class="hljs-built_in">this</span>.data[name];
        el.addEventListener(evName, func);
    }

    <span class="hljs-function"><span class="hljs-title">bindUnmount</span>(<span class="hljs-params">{elem}</span>)</span> {
        <span class="hljs-keyword">const</span> name = elem.getAttr(<span class="hljs-string">&#x27;name&#x27;</span>);
        <span class="hljs-keyword">const</span> [el, func, evName] = <span class="hljs-built_in">this</span>.boundElements[name];
        <span class="hljs-keyword">delete</span> <span class="hljs-built_in">this</span>.boundElements[name];
        el.removeEventListener(evName, func);
    }

    <span class="hljs-function"><span class="hljs-title">prepareCallback</span>(<span class="hljs-params">renderObj</span>)</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-71">&#x00a7;</a>
              </div>
              <p>console.log(‘this is data’, this.data);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">this</span>.initializedCallback(renderObj); <span class="hljs-comment">// TODO remove this, should not have to</span>
        <span class="hljs-built_in">this</span>.data.bindMount = <span class="hljs-built_in">this</span>.bindMount.bind(<span class="hljs-built_in">this</span>);<span class="hljs-comment">// Ugh hack</span>
        <span class="hljs-built_in">this</span>.data.bindUnmount = <span class="hljs-built_in">this</span>.bindUnmount.bind(<span class="hljs-built_in">this</span>);<span class="hljs-comment">// Ugh hack</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.data;
    }

    <span class="hljs-function"><span class="hljs-title">reloadCallback</span>(<span class="hljs-params">oldPart</span>)</span> {
        <span class="hljs-built_in">this</span>.data = <span class="hljs-built_in">Object</span>.assign({}, oldPart.data, <span class="hljs-built_in">this</span>.data, oldPart.data);
    }

    <span class="hljs-function"><span class="hljs-title">eventCallback</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>._oldData = <span class="hljs-built_in">Object</span>.assign({}, <span class="hljs-built_in">this</span>.data);
        <span class="hljs-built_in">Object</span>.assign(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.data);
    }

    <span class="hljs-function"><span class="hljs-title">eventCleanupCallback</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> name <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.data)) {
            <span class="hljs-keyword">if</span> (!(name <span class="hljs-keyword">in</span> <span class="hljs-built_in">this</span>._oldData)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-72">&#x00a7;</a>
              </div>
              <p>clean up extra</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">delete</span> <span class="hljs-built_in">this</span>.data[name];</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-73">&#x00a7;</a>
              </div>
              <p>this.set(name, null);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>[name] !== <span class="hljs-built_in">this</span>.data[name]) {
                <span class="hljs-built_in">this</span>.set(name, <span class="hljs-built_in">this</span>[name]); <span class="hljs-comment">// update</span>
            }
        }
        <span class="hljs-built_in">this</span>.component.rerender(); <span class="hljs-comment">// HACK</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-74">&#x00a7;</a>
              </div>
              <p>ToDo: Clean this up, maybe have data be what’s returned for
prepareEventCallback, just like with prepareCallback?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    <span class="hljs-function"><span class="hljs-title">get</span>(<span class="hljs-params">key</span>)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.data[key];
    }

    <span class="hljs-function"><span class="hljs-title">set</span>(<span class="hljs-params">key, value</span>)</span> {
        <span class="hljs-keyword">const</span> data = {[key]: value};
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.boundElements[key]) {
            <span class="hljs-keyword">const</span> [el, func, evName] = <span class="hljs-built_in">this</span>.boundElements[key];
            el.value = value;
        }
        <span class="hljs-built_in">this</span>.data = <span class="hljs-built_in">Object</span>.assign({}, <span class="hljs-built_in">this</span>.data, data);
        <span class="hljs-built_in">this</span>.component.rerender();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.ghostElem) {</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-75">&#x00a7;</a>
              </div>
              <p>update ghost element with change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">&#x27;string&#x27;</span>) {
                value = <span class="hljs-built_in">JSON</span>.stringify(value);
                key += <span class="hljs-string">&#x27;:&#x27;</span>;
            }
            <span class="hljs-built_in">this</span>.ghostElem.setAttribute(key, value);
        }
    }

}
Modulo.cparts.set(<span class="hljs-string">&#x27;state&#x27;</span>, Modulo.parts.State);</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-76">&#x00a7;</a>
              </div>
              <p>ModuloTemplate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> defaultOptions = {
    <span class="hljs-attr">modeTokens</span>: [<span class="hljs-string">&#x27;{% %}&#x27;</span>, <span class="hljs-string">&#x27;{{ }}&#x27;</span>, <span class="hljs-string">&#x27;{# #}&#x27;</span>],
    <span class="hljs-attr">opTokens</span>: <span class="hljs-string">&#x27;==,&gt;,&lt;,&gt;=,&lt;=,!=,not in,is not,is,in,not&#x27;</span>,
    <span class="hljs-attr">opAliases</span>: {
        <span class="hljs-string">&#x27;is&#x27;</span>: <span class="hljs-string">&#x27;X === Y&#x27;</span>,
        <span class="hljs-string">&#x27;is not&#x27;</span>: <span class="hljs-string">&#x27;X !== Y&#x27;</span>,
        <span class="hljs-string">&#x27;not&#x27;</span>: <span class="hljs-string">&#x27;!(Y)&#x27;</span>,
        <span class="hljs-string">&#x27;in&#x27;</span>: <span class="hljs-string">&#x27;typeof Y[X] !== &quot;undefined&quot; || Y.indexOf &amp;&amp; Y.indexOf(X) != -1&#x27;</span>,
    },
};

defaultOptions.modes = {
    <span class="hljs-string">&#x27;{%&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">text, tmplt, stack</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> tTag = text.trim().split(<span class="hljs-string">&#x27; &#x27;</span>)[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">const</span> tagFunc = tmplt.tags[tTag];
        <span class="hljs-keyword">if</span> (stack.length &amp;&amp; tTag === stack[stack.length - <span class="hljs-number">1</span>].close) {
            <span class="hljs-keyword">return</span> stack.pop().end; <span class="hljs-comment">// Closing tag, return it&#x27;s end code</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!tagFunc) { <span class="hljs-comment">// Undefined template tag</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Unknown template tag &quot;<span class="hljs-subst">${tTag}</span>&quot;: <span class="hljs-subst">${text}</span>`</span>);
        } <span class="hljs-comment">// Normal opening tag</span>
        <span class="hljs-keyword">const</span> result = tagFunc(text.slice(tTag.length + <span class="hljs-number">1</span>), tmplt);
        <span class="hljs-keyword">if</span> (result.end) { <span class="hljs-comment">// Not self-closing, push to stack</span>
            stack.push({<span class="hljs-attr">close</span>: <span class="hljs-string">`end<span class="hljs-subst">${tTag}</span>`</span>, ...result});
        }
        <span class="hljs-keyword">return</span> result.start || result;
    },
    <span class="hljs-string">&#x27;{#&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">text, tmplt</span>) =&gt;</span> {},
    <span class="hljs-string">&#x27;{{&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">text, tmplt</span>) =&gt;</span> <span class="hljs-string">`OUT.push(G.escapeHTML(<span class="hljs-subst">${tmplt.parseExpr(text)}</span>));`</span>,
    <span class="hljs-attr">text</span>: <span class="hljs-function">(<span class="hljs-params">text, tmplt</span>) =&gt;</span> text &amp;&amp; <span class="hljs-string">`OUT.push(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(text)}</span>);`</span>,
};

defaultOptions.filters = {
    <span class="hljs-attr">upper</span>: <span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.toUpperCase(),
    <span class="hljs-attr">lower</span>: <span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.toLowerCase(),
    <span class="hljs-attr">escapejs</span>: <span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> <span class="hljs-built_in">JSON</span>.stringify(s),
    <span class="hljs-attr">first</span>: <span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s[<span class="hljs-number">0</span>],
    <span class="hljs-attr">last</span>: <span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s[s.length - <span class="hljs-number">1</span>],
    <span class="hljs-attr">length</span>: <span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.length,
    <span class="hljs-attr">safe</span>: <span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> <span class="hljs-built_in">Object</span>.assign(<span class="hljs-keyword">new</span> <span class="hljs-built_in">String</span>(s), {<span class="hljs-attr">safe</span>: <span class="hljs-literal">true</span>}),
    <span class="hljs-attr">join</span>: <span class="hljs-function">(<span class="hljs-params">s, arg</span>) =&gt;</span> s.join(arg),
    <span class="hljs-attr">pluralize</span>: <span class="hljs-function">(<span class="hljs-params">s, arg</span>) =&gt;</span> arg.split(<span class="hljs-string">&#x27;,&#x27;</span>)[(s === <span class="hljs-number">1</span>) * <span class="hljs-number">1</span>],
    <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">s, arg</span>) =&gt;</span> s + arg,
    <span class="hljs-attr">subtract</span>: <span class="hljs-function">(<span class="hljs-params">s, arg</span>) =&gt;</span> s - arg,
    <span class="hljs-attr">default</span>: <span class="hljs-function">(<span class="hljs-params">s, arg</span>) =&gt;</span> s || arg,
    <span class="hljs-attr">divisibleby</span>: <span class="hljs-function">(<span class="hljs-params">s, arg</span>) =&gt;</span> ((s * <span class="hljs-number">1</span>) % (arg * <span class="hljs-number">1</span>)) === <span class="hljs-number">0</span>,
};

defaultOptions.tags = {
    <span class="hljs-string">&#x27;if&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">text, tmplt</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> [lHand, op, rHand] = tmplt.parseCondExpr(text);
        <span class="hljs-keyword">const</span> condStructure = !op ? <span class="hljs-string">&#x27;X&#x27;</span> : tmplt.opAliases[op] || <span class="hljs-string">`X <span class="hljs-subst">${op}</span> Y`</span>;
        <span class="hljs-keyword">const</span> condition = condStructure.replace(<span class="hljs-regexp">/([XY])/g</span>,
            <span class="hljs-function">(<span class="hljs-params">k, m</span>) =&gt;</span> tmplt.parseExpr(m === <span class="hljs-string">&#x27;X&#x27;</span> ? lHand : rHand));
        <span class="hljs-keyword">const</span> start = <span class="hljs-string">`if (<span class="hljs-subst">${condition}</span>) {`</span>;
        <span class="hljs-keyword">return</span> {start, <span class="hljs-attr">end</span>: <span class="hljs-string">&#x27;}&#x27;</span>};
    },
    <span class="hljs-string">&#x27;else&#x27;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">&#x27;} else {&#x27;</span>,
    <span class="hljs-string">&#x27;elif&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">s, tmplt</span>) =&gt;</span> <span class="hljs-string">&#x27;} else &#x27;</span> + tmplt.tags[<span class="hljs-string">&#x27;if&#x27;</span>](s, tmplt).start,
    <span class="hljs-string">&#x27;comment&#x27;</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">start</span>: <span class="hljs-string">&quot;/*&quot;</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">&quot;*/&quot;</span>}),
    <span class="hljs-string">&#x27;for&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">text, tmplt</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-77">&#x00a7;</a>
              </div>
              <p>Make variable name be based on nested-ness of tag stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> arrName = <span class="hljs-string">&#x27;ARR&#x27;</span> + tmplt.stack.length;
        <span class="hljs-keyword">const</span> [varExp, arrExp] = text.split(<span class="hljs-string">&#x27; in &#x27;</span>);
        <span class="hljs-keyword">let</span> start = <span class="hljs-string">`var <span class="hljs-subst">${arrName}</span>=<span class="hljs-subst">${tmplt.parseExpr(arrExp)}</span>;`</span>;
        start += <span class="hljs-string">`for (var KEY in <span class="hljs-subst">${arrName}</span>) {`</span>;
        <span class="hljs-keyword">const</span> [keyVar, valVar] = varExp.split(<span class="hljs-string">&#x27;,&#x27;</span>).map(cleanWord);
        <span class="hljs-keyword">if</span> (valVar) {
            start += <span class="hljs-string">`CTX.<span class="hljs-subst">${keyVar}</span>=KEY;`</span>;
        }
        start += <span class="hljs-string">`CTX.<span class="hljs-subst">${valVar ? valVar : varExp}</span>=<span class="hljs-subst">${arrName}</span>[KEY];`</span>;
        <span class="hljs-keyword">return</span> {start, <span class="hljs-attr">end</span>: <span class="hljs-string">&#x27;}&#x27;</span>};
    },
    <span class="hljs-string">&#x27;empty&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">text, {stack}</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-78">&#x00a7;</a>
              </div>
              <p>Make variable name be based on nested-ness of tag stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> varName = <span class="hljs-string">&#x27;G.FORLOOP_NOT_EMPTY&#x27;</span> + stack.length;
        <span class="hljs-keyword">const</span> oldEndCode = stack.pop().end; <span class="hljs-comment">// get rid of dangling for</span>
        <span class="hljs-keyword">const</span> start = <span class="hljs-string">`<span class="hljs-subst">${varName}</span>=true; <span class="hljs-subst">${oldEndCode}</span> if (!<span class="hljs-subst">${varName}</span>) {`</span>;
        <span class="hljs-keyword">const</span> end = <span class="hljs-string">`}<span class="hljs-subst">${varName}</span> = false;`</span>;
        <span class="hljs-keyword">return</span> {start, end, <span class="hljs-attr">close</span>: <span class="hljs-string">&#x27;endfor&#x27;</span>};
    },
};

Modulo.Template = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Template</span> </span>{
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">text, options = {}</span>)</span> {
        <span class="hljs-built_in">Object</span>.assign(<span class="hljs-built_in">this</span>, defaultOptions, options);
        <span class="hljs-built_in">this</span>.opAliases[<span class="hljs-string">&#x27;not in&#x27;</span>] = <span class="hljs-string">`!(<span class="hljs-subst">${<span class="hljs-built_in">this</span>.opAliases[<span class="hljs-string">&#x27;in&#x27;</span>]}</span>)`</span>;
        <span class="hljs-built_in">this</span>.renderFunc = <span class="hljs-built_in">this</span>.compile(text);
    }

    <span class="hljs-function"><span class="hljs-title">tokenizeText</span>(<span class="hljs-params">text</span>)</span> {
        <span class="hljs-keyword">const</span> re = <span class="hljs-string">&#x27;(&#x27;</span> + <span class="hljs-built_in">this</span>.modeTokens.join(<span class="hljs-string">&#x27;|(&#x27;</span>).replace(<span class="hljs-regexp">/ +/g</span>, <span class="hljs-string">&#x27;)(.+?)&#x27;</span>);
        <span class="hljs-keyword">return</span> text.split(<span class="hljs-built_in">RegExp</span>(re)).filter(<span class="hljs-function"><span class="hljs-params">token</span> =&gt;</span> token !== <span class="hljs-literal">undefined</span>);
    }

    <span class="hljs-function"><span class="hljs-title">compile</span>(<span class="hljs-params">text</span>)</span> {
        <span class="hljs-built_in">this</span>.stack = []; <span class="hljs-comment">// Template tag stack</span>
        <span class="hljs-keyword">let</span> output = <span class="hljs-string">&#x27;var OUT=[];&#x27;</span>;
        <span class="hljs-keyword">let</span> mode = <span class="hljs-string">&#x27;text&#x27;</span>; <span class="hljs-comment">// Start in text mode</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.tokenizeText(text)) {
            <span class="hljs-keyword">if</span> (mode) {
                <span class="hljs-keyword">const</span> result = <span class="hljs-built_in">this</span>.modes[mode](token, <span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.stack);
                output += result || <span class="hljs-string">&#x27;&#x27;</span>;
            }
            mode = (mode === <span class="hljs-string">&#x27;text&#x27;</span>) ? <span class="hljs-literal">null</span> : (mode ? <span class="hljs-string">&#x27;text&#x27;</span> : token);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">&#x27;CTX,G&#x27;</span>, output + <span class="hljs-string">&#x27;;return OUT.join(&quot;&quot;);&#x27;</span>);
    }

    <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params">renderContext</span>)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.renderFunc(<span class="hljs-built_in">Object</span>.assign({}, renderContext), <span class="hljs-built_in">this</span>);
    }

    <span class="hljs-function"><span class="hljs-title">parseExpr</span>(<span class="hljs-params">text</span>)</span> {
        <span class="hljs-keyword">const</span> filters = text.split(<span class="hljs-string">&#x27;|&#x27;</span>);
        <span class="hljs-keyword">let</span> results = <span class="hljs-built_in">this</span>.parseVal(filters.shift());
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [fName, arg] <span class="hljs-keyword">of</span> filters.map(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.trim().split(<span class="hljs-string">&#x27;:&#x27;</span>))) {
            <span class="hljs-keyword">const</span> argList = arg ? <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">this</span>.parseVal(arg) : <span class="hljs-string">&#x27;&#x27;</span>;
            results = <span class="hljs-string">`G.filters[&quot;<span class="hljs-subst">${fName}</span>&quot;](<span class="hljs-subst">${results}</span><span class="hljs-subst">${argList}</span>)`</span>;
        }
        <span class="hljs-keyword">return</span> results;
    }

    <span class="hljs-function"><span class="hljs-title">parseCondExpr</span>(<span class="hljs-params">text</span>)</span> {
        <span class="hljs-keyword">const</span> reText = <span class="hljs-string">` (<span class="hljs-subst">${<span class="hljs-built_in">this</span>.opTokens.split(<span class="hljs-string">&#x27;,&#x27;</span>).join(<span class="hljs-string">&#x27;|&#x27;</span>)}</span>) `</span>;
        <span class="hljs-keyword">return</span> text.split(<span class="hljs-built_in">RegExp</span>(reText));
    }

    <span class="hljs-function"><span class="hljs-title">parseVal</span>(<span class="hljs-params">s</span>)</span> {
        s = s.trim();
        <span class="hljs-keyword">if</span> (s.match(<span class="hljs-regexp">/^(&#x27;.*&#x27;|&quot;.*&quot;)$/</span>)) { <span class="hljs-comment">// String literal</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(s.substr(<span class="hljs-number">1</span>, s.length - <span class="hljs-number">2</span>));
        }
        <span class="hljs-keyword">return</span> s.match(<span class="hljs-regexp">/^\d+$/</span>) ? s : <span class="hljs-string">`CTX.<span class="hljs-subst">${cleanWord(s)}</span>`</span>
    }

    <span class="hljs-function"><span class="hljs-title">escapeHTML</span>(<span class="hljs-params">text</span>)</span> {
        <span class="hljs-keyword">if</span> (text &amp;&amp; text.safe) {
            <span class="hljs-keyword">return</span> text;
        }
        <span class="hljs-keyword">return</span> (text + <span class="hljs-string">&#x27;&#x27;</span>).replace(<span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">&#x27;&amp;amp;&#x27;</span>)
            .replace(<span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">&#x27;&amp;lt;&#x27;</span>).replace(<span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">&#x27;&amp;gt;&#x27;</span>);
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-79">&#x00a7;</a>
              </div>
              <p>ModuloDomReconcile</p>
<p>setDOM ——————</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Modulo.SetDomReconciler = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SetDomReconciler</span> </span>{
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.KEY = <span class="hljs-string">&#x27;key&#x27;</span>
        <span class="hljs-built_in">this</span>.IGNORE = <span class="hljs-string">&#x27;modulo-ignore&#x27;</span>
        <span class="hljs-built_in">this</span>.CHECKSUM = <span class="hljs-string">&#x27;modulo-checksum&#x27;</span>
        <span class="hljs-built_in">this</span>.KEY_PREFIX = <span class="hljs-string">&#x27;_set-dom-&#x27;</span>
        <span class="hljs-built_in">this</span>.mockBody = Modulo.globals.document.implementation.createHTMLDocument(<span class="hljs-string">&#x27;&#x27;</span>).body;
    }

    <span class="hljs-function"><span class="hljs-title">reconcile</span>(<span class="hljs-params">component, newHTML</span>)</span> {
        <span class="hljs-built_in">this</span>.componentContext = component;
        <span class="hljs-keyword">if</span> (!component.isMounted) {
            component.innerHTML = newHTML;
            <span class="hljs-built_in">this</span>.findAndApplyDirectives(component);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">this</span>.mockBody.innerHTML = <span class="hljs-string">`&lt;div&gt;<span class="hljs-subst">${newHTML}</span>&lt;/div&gt;`</span>;
            <span class="hljs-built_in">this</span>.setChildNodes(component, <span class="hljs-built_in">this</span>.mockBody.firstChild);
        }
        <span class="hljs-built_in">this</span>.componentContext = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-function"><span class="hljs-title">findAndApplyDirectives</span>(<span class="hljs-params">element</span>)</span> {
        <span class="hljs-keyword">const</span> directives = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> child <span class="hljs-keyword">of</span> element.children) {
            Modulo.collectDirectives(<span class="hljs-built_in">this</span>.componentContext, child, directives);
        }
        <span class="hljs-built_in">this</span>.componentContext.applyDirectives(directives);
    }

    <span class="hljs-comment">/**
    * <span class="hljs-doctag">@private</span>
    * <span class="hljs-doctag">@description</span>
    * Updates a specific htmlNode and does whatever it takes to convert it to another one.
    *
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">oldNode</span></span> - The previous HTMLNode.
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">newNode</span></span> - The updated HTMLNode.
    */</span>
    <span class="hljs-function"><span class="hljs-title">setNode</span>(<span class="hljs-params">oldNode, newNode</span>)</span> {
        <span class="hljs-keyword">if</span> (oldNode.nodeType !== newNode.nodeType || oldNode.nodeName !== newNode.nodeName) {</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-80">&#x00a7;</a>
              </div>
              <p>We have to fully replace the node — the tag/type doesn’t match
this.dismount(oldNode);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            oldNode.parentNode.replaceChild(newNode, oldNode)
            <span class="hljs-built_in">this</span>.mount(newNode);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldNode.nodeType !== <span class="hljs-number">1</span>) { <span class="hljs-comment">// 1 === ELEMENT_TYPE</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-81">&#x00a7;</a>
              </div>
              <p>Handle other types of node updates (text/comments/etc).
TODO: Is this if statement even a useful optimization..?
if (oldNode.nodeValue !== newNode.nodeValue) {
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            oldNode.nodeValue = newNode.nodeValue;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.isEqualNode(oldNode, newNode)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-82">&#x00a7;</a>
              </div>
              <p>Update children &amp; attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">this</span>.setChildNodes(oldNode, newNode);
            <span class="hljs-built_in">this</span>.setAttributes(oldNode.attributes, newNode.attributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-83">&#x00a7;</a>
              </div>
              <p>TODO: do dismounts as necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }
    }

    <span class="hljs-comment">/**
    * <span class="hljs-doctag">@private</span>
    * <span class="hljs-doctag">@description</span>
    * Utility that will update one list of attributes to match another.
    *
    * <span class="hljs-doctag">@param <span class="hljs-type">{NamedNodeMap}</span> <span class="hljs-variable">oldAttributes</span></span> - The previous attributes.
    * <span class="hljs-doctag">@param <span class="hljs-type">{NamedNodeMap}</span> <span class="hljs-variable">newAttributes</span></span> - The updated attributes.
    */</span>
    setAttributes (oldAttributes, newAttributes) {
      <span class="hljs-keyword">let</span> i, a, b, ns, name</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-84">&#x00a7;</a>
              </div>
              <p>Remove old attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (i = oldAttributes.length; i--;) {
        a = oldAttributes[i]
        ns = a.namespaceURI
        name = a.localName
        b = newAttributes.getNamedItemNS(ns, name)
        <span class="hljs-keyword">if</span> (!b) oldAttributes.removeNamedItemNS(ns, name)
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-85">&#x00a7;</a>
              </div>
              <p>Set new attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (i = newAttributes.length; i--;) {
        a = newAttributes[i]
        ns = a.namespaceURI
        name = a.localName
        b = oldAttributes.getNamedItemNS(ns, name)
        <span class="hljs-keyword">if</span> (!b) {</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-86">&#x00a7;</a>
              </div>
              <p>Add a new attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          newAttributes.removeNamedItemNS(ns, name)
          oldAttributes.setNamedItemNS(a)
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (b.value !== a.value) {</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-87">&#x00a7;</a>
              </div>
              <p>Update existing attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          b.value = a.value
        }
      }
    }

    <span class="hljs-comment">/**
    * <span class="hljs-doctag">@private</span>
    * <span class="hljs-doctag">@description</span>
    * Utility that will nodes childern to match another nodes children.
    *
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">oldParent</span></span> - The existing parent node.
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">newParent</span></span> - The new parent node.
    */</span>
    setChildNodes (oldParent, newParent) {
      <span class="hljs-keyword">const</span> keyedNodes = {};
      <span class="hljs-keyword">let</span> checkOld, oldKey, checkNew, newKey, foundNode
      <span class="hljs-keyword">let</span> oldNode = oldParent.firstChild
      <span class="hljs-keyword">let</span> newNode = newParent.firstChild
      <span class="hljs-keyword">let</span> extra = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-88">&#x00a7;</a>
              </div>
              <p>Extract keyed nodes from previous children and keep track of total
count.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">while</span> (oldNode) {
          extra++
          checkOld = oldNode
          oldKey = <span class="hljs-built_in">this</span>.getKey(checkOld)
          oldNode = oldNode.nextSibling
          <span class="hljs-keyword">if</span> (oldKey) {
              keyedNodes[oldKey] = checkOld
          }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-89">&#x00a7;</a>
              </div>
              <p>Loop over new nodes and perform updates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      oldNode = oldParent.firstChild
      <span class="hljs-keyword">while</span> (newNode) {
          extra--
          checkNew = newNode
          newNode = newNode.nextSibling

          <span class="hljs-keyword">const</span> newKey = <span class="hljs-built_in">this</span>.getKey(checkNew);
          <span class="hljs-keyword">const</span> foundNode = newKey ? keyedNodes[newKey] : <span class="hljs-literal">null</span>;
          <span class="hljs-keyword">if</span> (foundNode) {
              <span class="hljs-keyword">delete</span> keyedNodes[newKey]</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-90">&#x00a7;</a>
              </div>
              <p>If we have a key and it existed before we move the previous
node to the new position if needed and diff it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (foundNode !== oldNode) {
                  oldParent.insertBefore(foundNode, oldNode)
              } <span class="hljs-keyword">else</span> {
                  oldNode = oldNode.nextSibling
              }

              <span class="hljs-built_in">this</span>.setNode(foundNode, checkNew)
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldNode) {
              checkOld = oldNode
              oldNode = oldNode.nextSibling
              <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getKey(checkOld)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-91">&#x00a7;</a>
              </div>
              <p>If the old child had a key we skip over it until the end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  oldParent.insertBefore(checkNew, checkOld)
                  <span class="hljs-built_in">this</span>.mount(checkNew)
              } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-92">&#x00a7;</a>
              </div>
              <p>Otherwise we diff the two non-keyed nodes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  <span class="hljs-built_in">this</span>.setNode(checkOld, checkNew)
              }
          } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-93">&#x00a7;</a>
              </div>
              <p>Finally if there was no old node we add the new node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              oldParent.appendChild(checkNew)
              <span class="hljs-keyword">if</span> (checkNew.nodeType === <span class="hljs-number">1</span>) { <span class="hljs-comment">// 1 === ELEMENT_TYPE</span>
                  <span class="hljs-built_in">this</span>.mount(checkNew)
              }
          }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-94">&#x00a7;</a>
              </div>
              <p>Remove old keyed nodes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (oldKey <span class="hljs-keyword">in</span> keyedNodes) {
        extra--
        oldParent.removeChild(<span class="hljs-built_in">this</span>.dismount(keyedNodes[oldKey]))
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-95">&#x00a7;</a>
              </div>
              <p>If we have any remaining unkeyed nodes remove them from the end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">while</span> (--extra &gt;= <span class="hljs-number">0</span>) {
        oldParent.removeChild(<span class="hljs-built_in">this</span>.dismount(oldParent.lastChild))
      }
    }

    <span class="hljs-comment">/**
    * <span class="hljs-doctag">@private</span>
    * <span class="hljs-doctag">@description</span>
    * Utility to try to pull a key out of an element.
    * Uses &#x27;data-key&#x27; if possible and falls back to &#x27;id&#x27;.
    *
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">node</span></span> - The node to get the key for.
    * <span class="hljs-doctag">@return <span class="hljs-type">{string|void}</span></span>
    */</span>
    getKey (node) {
      <span class="hljs-keyword">if</span> (node.nodeType !== <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 1 === ELEMENT_TYPE</span>
      <span class="hljs-keyword">let</span> key = node.getAttribute(<span class="hljs-built_in">this</span>.KEY) || node.id
      <span class="hljs-keyword">if</span> (key) <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.KEY_PREFIX + key
    }

    <span class="hljs-comment">/**
    * Checks if nodes are equal using the following by checking if
    * they are both ignored, have the same checksum, or have the
    * same contents.
    *
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">a</span></span> - One of the nodes to compare.
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">b</span></span> - Another node to compare.
    */</span>
    isEqualNode (a, b) {
      <span class="hljs-keyword">return</span> (</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-96">&#x00a7;</a>
              </div>
              <p>Check if both nodes are ignored.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        (<span class="hljs-built_in">this</span>.isIgnored(a) &amp;&amp; <span class="hljs-built_in">this</span>.isIgnored(b)) ||</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-97">&#x00a7;</a>
              </div>
              <p>Check if both nodes have the same checksum.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        (<span class="hljs-built_in">this</span>.getCheckSum(a) === <span class="hljs-built_in">this</span>.getCheckSum(b)) ||</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-98">&#x00a7;</a>
              </div>
              <p>Fall back to native isEqualNode check.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        a.isEqualNode(b)
      )
    }

    <span class="hljs-comment">/**
    * <span class="hljs-doctag">@private</span>
    * <span class="hljs-doctag">@description</span>
    * Utility to try to pull a checksum attribute from an element.
    * Uses &#x27;data-checksum&#x27; or user specified checksum property.
    *
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">node</span></span> - The node to get the checksum for.
    * <span class="hljs-doctag">@return <span class="hljs-type">{string|NaN}</span></span>
    */</span>
    getCheckSum (node) {
      <span class="hljs-keyword">return</span> node.getAttribute(<span class="hljs-built_in">this</span>.CHECKSUM) || <span class="hljs-literal">NaN</span>
    }

    <span class="hljs-comment">/**
    * <span class="hljs-doctag">@private</span>
    * <span class="hljs-doctag">@description</span>
    * Utility to try to check if an element should be ignored by the algorithm.
    * Uses &#x27;data-ignore&#x27; or user specified ignore property.
    *
    * <span class="hljs-doctag">@param <span class="hljs-type">{Node}</span> <span class="hljs-variable">node</span></span> - The node to check if it should be ignored.
    * <span class="hljs-doctag">@return <span class="hljs-type">{boolean}</span></span>
    */</span>
    isIgnored (node) {
      <span class="hljs-keyword">return</span> node.getAttribute(<span class="hljs-built_in">this</span>.IGNORE) != <span class="hljs-literal">null</span>
    }

    mount (node) {
        <span class="hljs-built_in">this</span>.findAndApplyDirectives(node);
        <span class="hljs-keyword">return</span> node;
    }
    <span class="hljs-function"><span class="hljs-title">dismount</span>(<span class="hljs-params">node</span>)</span> {
        <span class="hljs-keyword">return</span> node;
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-99">&#x00a7;</a>
              </div>
              <p>/setDOM ——————</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Modulo.utils = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">utils</span> </span>{
    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">simplifyResolvedLiterals</span>(<span class="hljs-params">attrs</span>)</span> {
        <span class="hljs-keyword">const</span> obj = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [name, value] <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.entries(attrs)) {
            name = name.replace(<span class="hljs-regexp">/-([a-z])/g</span>, <span class="hljs-function"><span class="hljs-params">g</span> =&gt;</span> g[<span class="hljs-number">1</span>].toUpperCase());
            <span class="hljs-keyword">if</span> (name.endsWith(<span class="hljs-string">&#x27;:&#x27;</span>)) {
                name = name.slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// slice out colon</span>
                value = <span class="hljs-built_in">JSON</span>.parse(value);
            }
            obj[name] = value;
        }
        <span class="hljs-keyword">return</span> obj;
    }
    <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-title">parseAttrs</span>(<span class="hljs-params">elem</span>)</span> {
        <span class="hljs-keyword">const</span> obj = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> name <span class="hljs-keyword">of</span> elem.getAttributeNames()) {
            <span class="hljs-keyword">const</span> value = elem.getAttribute(name);
            name = name.replace(<span class="hljs-regexp">/-([a-z])/g</span>, <span class="hljs-function"><span class="hljs-params">g</span> =&gt;</span> g[<span class="hljs-number">1</span>].toUpperCase());
            obj[name] = value;
        }
        <span class="hljs-keyword">return</span> obj;
    }
}

Modulo.assert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assert</span>(<span class="hljs-params">value, ...info</span>) </span>{
    <span class="hljs-keyword">if</span> (!value) {
        <span class="hljs-built_in">console</span>.error(...info);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Modulo Error: &quot;<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(info).join(<span class="hljs-string">&#x27; &#x27;</span>)}</span>&quot;`</span>)
    }
}
<span class="hljs-comment">/*
# HACKY FUNCTIONS
Pls ignore all
*/</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGetAttr</span>(<span class="hljs-params">element</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-100">&#x00a7;</a>
              </div>
              <p>HACK</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (element.getAttr) {
        <span class="hljs-keyword">return</span> element.getAttr;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> element.getAttribute(...args);
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanWord</span>(<span class="hljs-params">text</span>) </span>{
    <span class="hljs-keyword">return</span> (text + <span class="hljs-string">&#x27;&#x27;</span>).replace(<span class="hljs-regexp">/[^a-zA-Z0-9$_\.]/g</span>, <span class="hljs-string">&#x27;&#x27;</span>) || <span class="hljs-string">&#x27;&#x27;</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFirstModuloAncestor</span>(<span class="hljs-params">elem</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-101">&#x00a7;</a>
              </div>
              <p>Walk up tree to first DOM node that is a modulo component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> node = elem.parentNode;
    <span class="hljs-keyword">return</span> !node ? <span class="hljs-literal">null</span> : (
        node.isModuloElement ? node : getFirstModuloAncestor(node)
    );
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span>) { <span class="hljs-comment">// Node</span>
    <span class="hljs-built_in">module</span>.exports = Modulo;
}
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> customElements !== <span class="hljs-string">&#x27;undefined&#x27;</span>) { <span class="hljs-comment">// Browser</span>
    globals = <span class="hljs-built_in">window</span>;
}
Modulo.globals = globals;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
