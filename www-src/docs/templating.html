<script src="/m.js"></script>
<x-Page
    docbarselected="/templating.html"
    pagetitle="Templating"
    navbar="docs">

<h1>Modulo Templating Language</h1>

<p>This document explains the language syntax and functionality of the included
Modulo template system.</p>

<p>Modulo's templating language is designed to strike a balance between power
and ease. It's designed to feel comfortable to those only used to working with
HTML. If you have any exposure to other similar template languages, such as
Django (Python), Shopify's Liquid (Ruby), Hugo (Go), Jinja2 (Python), Nunjucks
(JavaScript), or Twig (PHP), you should feel right at home with Modulo's
templates. In fact, Modulo's templating was modeled so closely on Django's,
that much of this documentation was <a
href="https://docs.djangoproject.com/en/3.2/ref/templates/language/">
directly copied from Django</a>. This also means that most text editors
already can highlight Modulo template code: Just configure it for Django
templates.  Thanks, Django!</p>



<div class="InfoBox">
    <h2>Philosophy</h2>

    <p>In approach, Modulo's tempting language joins the ranks of the <a
    target="_blank"
    href="https://i5ar.medium.com/template-languages-a7b362971cbc">"Djangolike"</a>
    templating languages: Intentionally limited, and resembling markup more
    than programming code.  If you're used to languages which permit mixing
    programming code directly with DOM elements, such as with React or Svelte,
    you'll want to bear in mind that the Modulo template system is not simply
    JavaScript embedded into HTML. This is by design: the template system is
    meant to express presentation, not program logic.</p>

    <p>The Modulo template system provides "tags" which function similarly to some
    programming constructs&mdash;an if tag for boolean tests, a for tag for
    looping, etc.&mdash;but the template system will not execute arbitrary
    JavaScript expressions. Only the tags, filters and syntax listed here is
    supported by default (although you can add your own extensions to the template
    language as needed).</p>

    <p>Why use a text-based template instead of an XML-based one (like React's
    JSX), or an attribute DOM-based one (like Vue, Angular, or Riot)? The same
    reason behind the MVC paradigm: "To separate internal representations of
    information from the ways information is presented to and accepted from the
    user". Supporting pure-text output enforces this clear wall of separation
    between presentation and business logic. Furthermore, this will be more
    familiar to backend developers more familiar with string-based templating
    in general (such as Ruby, Python, or PHP developers).</p>
</div>

<mws-Section name="templates">Templates</mws-Section>

<p>A "template" is the text within a Template CPart. Most Components defined
within Modulo will also define a Template CPart in order to render their
contents.</p>

<p>A template contains variables, which get replaced with values when the
template is evaluated, and tags, which control the logic of the template.</p>

<p>Below is a minimal template that illustrates a few basics. Each element will
be explained later in this document.</p>


<mdu-CodeExample
vsize=255
text='
<template>
<p>There are <em>{{ state.count }}
  {{ state.count|pluralize:"articles,article" }}</em>
  on {{ script.exports.title }}.</p>

{# Show the articles #}
{% for article in state.articles %}
    <h4 style="color: blue">{{ article.headline|upper }}</h4>
    {% if article.tease %}
      <p>{{ article.tease|truncate:30 }}</p>
    {% endif %}
{% endfor %}
</template>



<!-- The data below was used to render the template above -->
<state
    count:=42
    articles:=&#x27;[
      {"headline": "Modulo released!",
       "tease": "The most exciting news of the century."},
      {"headline": "Can JS be fun again?"},
      {"headline": "MTL considered harmful",
       "tease": "Why constructing JS is risky business."}
    ]&#x27;
></state>
<script>
    script.exports.title = "ModuloNews";
</script>
'></mdu-CodeExample>




<mws-Section name="variables">Variables</mws-Section>

<p>Variables look like this: <code>{{ variable }}</code>. When the template
engine encounters a variable, it evaluates that variable and replaces it with
the result. Variable names consist of any combination of alphanumeric
characters and the underscore ("_") but may not start with an underscore, and
may not be a number. The dot (".") also appears in variable sections, although
that has a different meaning, as indicated below. Importantly, you cannot have
spaces or punctuation characters in variable names.</p>

<h3>The dot (.)</h3>

<p>Use a dot (.) to access sub-properties of a variable. This syntax is much
like JavaScript.</p>

<p>In the above example, <code>{{ state.count }}</code> will be replaced with
the value of the "count" property of the state data. Similarly,
<code>{{ script.exports.title }}</code> reaches even further, by first
accessing the <code>script</code> variable, then the <code>exports</code>
subproperty, then the <code>title</code> subproperty.</p>

<p>If you use a variable that doesn't exist, the template system will insert
the value of <code>undefined</code>, much like in JavaScript.</p>

<p>Note that "bar" in a template expression like <code>{{ foo.bar }}</code> will be
interpreted as a literal string and not using the value of the variable "bar",
if one exists in the template context. If you wish to to do the opposite
behavior, that is, actually resolve "bar" into it's own value, and then use
that value to access a property of bar, consider using the "|get" filter
(explained later).</p>

<p>Variable attributes that begin with an underscore should generally not be
accessed, as that can be used to indicate private.</p>

<h3>What variables are available</h3>

<p>Variables come from the component's renderObj that is produced in the
<code>prepare</code> stage. <a href="/docs/directives.html#renderobj">More on
the "renderObj" in the section on lifecycle.</a></p>

<p>In practicality, this is another way to say that most variables typically
"come from" the CParts of a component.</p>


<h4>Variables from CParts</h4>

<p>Each <em>CPart</em> within a given component may contribute a variable to
the <em>Template</em>. Of the built-in CParts, the following contribute a
variable with useful data:</p>

<ul>
    <li><strong>Props</strong> - If the <em>Props</em> CPart is present, then
    you will have a <code>{{ props }}</code> variable available. This gives
    access to the current value of props data. For example,
    <code>{{ props.title }}</code> gives access to the current value of the
    "title" attribute of the component.</li>

    <li><strong>State</strong> - If the <em>State</em> CPart is present, then
    you will have a <code>{{ state }}</code> variable available. This gives
    access to the current value of state data, the object that represents
    state. For example, <code>{{ state.number }}</code> gives access to the
    current value of the "number" property of state.</li>

    <li><strong>Script</strong> - If the <em>Script</em> CPart is present, then
    you will have a <code>{{ script }}</code> variable available. The main use
    of this is to access the <code>{{ script.exports }}</code> variable. This
    can be set within the script tag as a way to store global, static data
    shared between all instances of a component.</li>
</ul>


<h4>Variables from templatetags</h4>

<p>We'll go over template-tags later, but some template-tags can add variables
into the mix as well. As a sneak-peak, examine the following code:</p>

<pre>
{% for athlete in state.athletes %}
    &lt;p&gt;{{ athlete.name }}&lt;/p&gt;
{% endfor %}
</pre>

<p>Note how <code>athlete</code> declares a new variable, which can be reused
in <code>{{ athlete.name }}</code>. For more on for-loops, see the 
<a href="/docs/template_reference.html#tags">built-in
template-tag reference.</a></p>



<mws-Section name="filters">Filters</mws-Section>

<p>You can modify variables for display by using filters.</p>

<p>Filters look like this: <code>{{ name|lower }}</code>. This displays the
value of the <code>{{ name }}</code> variable after being filtered through the
lower filter, which converts text to lowercase. Use a pipe (|) to apply a
filter.</p>

<p>Filters can be "chained." The output of one filter is applied to the next.
<code>{{ text|escape|linebreaks }}</code> is a common idiom for escaping text
contents, then converting line breaks to &lt;p&gt; tags.</p>

<p>Some filters take arguments. A filter argument looks like this:
<code>{{ bio|truncate:30 }}</code>.
This will display the first 30 characters of the bio variable, possibly
appending an ellipsis if its full length exceeds that.</p>

<p>Filter arguments that contain spaces must be quoted; for example, to join a
list with commas and spaces you'd use <code>{{ list|join:", " }}</code>.</p>

<p>Modulo's templating language provides several dozen built-in template
filters. You can read all about them in the
<a href="/docs/template_reference.html#filters">built-in filter reference</a>.
To give you a taste of what's available, here are some of the more commonly
used template filters:</p>


<div class="InfoBox">
  <h2>Common filters</h2>

<h3>default</h3>
<p>If a variable is false or empty, use given default. Otherwise, use the value of
the variable. For example:</p>

<pre>
{{ value|default:"nothing" }}
</pre>

<p>If value isn't provided or is empty, the above will display "nothing".</p>


<h3>length</h3>
<p>Returns the length of the value. This works for both strings and lists. For
example:</p>

<pre>
{{ state.articles|length }}
</pre>

<p>If <code>state.items</code> is <code>['a', 'b', 'c', 'd']</code>, the output
will be 4.</p>
</div>

<p>Again, these are just a few examples; see the <a
href="/docs/template_reference.html#filters">built-in filter reference</a>.
for the complete list.</p>

<p>You can also create your own custom template filters; see Custom template
tags and filters.</p>


<mws-Section name="tags">Tags</mws-Section>

<p>Tags look like this: <code>{% tag %}</code>. Tags are more complex than
variables: Some create text in the output, some control flow by performing
loops or logic, and some load external information into the template to be used
by later variables.</p>

<p>Some tags require beginning and ending tags (i.e. <code>{% tag %} ...
tag contents ... {% endtag %}</code>).</p>

<p>Modulo ships with several built-in template-tags. You can read all about
them in the <a
href="/docs/template_reference.html#filters">built-in template-tag reference</a>.</p>

<div class="InfoBox">
  <h2>Common Template-Tags</h2>

<p>Here are a couple commonly used template-tags:</p>

<h4>for</h4>
<p>Duplicate a block of HTML code for every item in a collection of items (e.g.
an array). This allows a HTML code to be repeated while looping over each item
in an array. For example, to display a list of athletes provided in
<code>state.athletes</code>:</p>

<pre>
&lt;ul&gt;
    {% for athlete in state.athletes %}
        &lt;li&gt;{{ athlete.name }}&lt;/li&gt;
    {% endfor %}
&lt;/ul&gt;
</pre>

<h4>if</h4>
<p>Evaluates a variable, and if that variable is "true" the contents of the
block are displayed:</p>

<pre>
{% if state.athletes %}
    Number of athletes: {{ state.athletes|length }}
{% endif %}
</pre>

<p>In the above, if state.athletes is not empty, the number of athletes will be
displayed by the {{ state.athletes|length }} variable.</p>

<p>You can also use filters and various operators in the if tag:</p>

<pre>
{% if state.athletes|length gt 1 %}
   Team: {% for athlete in state.athletes %} ... {% endfor %}
{% else %}
   Athlete: {{ state.athletes|first }}
{% endif %}
</pre>
</div>


<h3>Final notes on tags</h3>

<p>The most important difference between template tags and template filters are
that template tags are interpreted at compile-time (when the template is first
loaded), while filters are interpreted at render time (when the component is
outputting it's HTML into the DOM). This means that mistakes with template tags
might stop the component from rendering at all (mistakes such as syntax typo or
a buggy third-party template tag), while mistakes with filters may only be
detected when it tries using it, and could even be overlooked if the filter
doesn't get used, e.g. it's only within an if statement that you haven't
tested.</p>

<p>Also, while the above examples work, be aware that some template filters
return strings, so mathematical comparisons using filters will generally not
work as you expect. <code>|length</code> is an exception. You can use
<code>|number</code> in other cases.</p>

<p>Finally, just like filters, you can also create your own custom template
tags; see <a href="/docs/template_reference.html">Template Reference</a>.</p>


<mws-Section name="comments">Comments</mws-Section>

<p>To comment-out part of a line in a template, use the comment syntax:
<code>{# text in here is ignored #}</code>. This syntax should only be used for
single-line comments. Due to this, it's not intended for "commenting out" or
disabling portions of template code.</p>

<p>If you need to comment out a multiline portion of the template, especially a
block of other template code, use the comment tag instead syntax instead. This
looks like: <code>{% comment %}text in here is ignored{% endcomment %}</code></p>

<p>Examples of both are below:</p>

<mdu-CodeExample
text='
<template>
    <h1>hello {# greeting #}</h1>
    {% comment %}
      {% if a %}<div>{{ b }}</div>{% endif %}
      <h3>{{ state.items|first }}</h3>
    {% endcomment %}
    <p>Below the greeting...</p>
</template>
'></mdu-CodeExample>

<mws-Section name="escaping">Escaping</mws-Section>

<p>By default in Modulo, every template automatically escapes the output of
every variable value. Specifically, these five characters are escaped:</p>

<ul>
    <li>&gt; is converted to &amp;lt;</li>
    <li>&lt; is converted to &amp;gt;</li>
    <li>' (single quote) is converted to &amp;#x27;</li>
    <li>" (double quote) is converted to &amp;quot;</li>
    <li>&amp; is converted to &amp;amp;</li>
</ul>

<div class="InfoBox">
<h2>Why escape</h2>

<p>When generating HTML from templates, there's always a risk that a variable
will include characters that affect the resulting HTML. For example, consider
this template fragment:</p>

<pre>
&lt;p&gt;Hello, {{ state.name }}&lt;/p&gt;
</pre>

<p>Imagine if a user were to enter their name as
<code>&lt;/p&gt;&lt;h1&gt;Big</code>. If the template system were to insert
that value directly, without modification, it would result in the P tag getting
closed prematurely, and a H1 tag taking over, making the text large.</p>

<p>Clearly, user-submitted data shouldn't be trusted blindly and inserted
directly into your Web pages. A malicious user could even use this
vulnerability to do potentially bad things. This type of security exploit is
called a Cross Site Scripting (XSS) attack. To avoid this problem, Modulo uses
automatic escaping.</p>
</div>

<h3>How to turn it off</h3>

<p>First, you might ask, why would you want to turn this security off? Because
sometimes, template variables contain data that you intend to be rendered as
raw HTML, in which case you don't want their contents to be escaped. For
example, you might store a blob of HTML in your state that is loaded from a
database, and want to embed that directly into your template.</p>

<p>To disable auto-escaping for an individual variable, use the safe
filter:</p>

<pre>
This will be escaped: {{ state.content }}
This will not be escaped: {{ state.content|safe }}
</pre>

<p>Think of safe as shorthand for safe from further escaping or can be safely
interpreted as HTML. In this example, if data contains '&lt;b&gt;', the output
will be:</p>

<pre>
This will be escaped: &amp;lt;b&amp;gt;
This will not be escaped: &lt;b&gt;
</pre>

<p>Keep in mind that you should only mark trusted data as <code>|safe</code>.
You don't want anyone trying to slip in malicious JS behavior!  Examine the
code below for a concrete example of how this escaping behaves:</p>

<mdu-CodeExample
text='
<template>
<p>User "<em>{{ state.username }}</em>" sent a message:</p>
<div class="msgcontent">
    {{ state.content|safe }}
</div>
</template>

<state
    username="Little <Bobby> <Drop> &tables"
    content=&#x27;
        I <i>love</i> the classic <a target="_blank"
        href="https://xkcd.com/327/">xkcd #327</a> on
        the risk of trusting <b>user inputed data</b>
    &#x27;
></state>
<style>
    .msgcontent {
        background: #999;
        padding: 10px;
        margin: 10px;
    }
</style>
'></mdu-CodeExample>

</x-Page>
