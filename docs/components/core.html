<!DOCTYPE HTML>
<head></head><body><module>
    <script>
        let txt
        function sloccount() {
            if (!txt) {
                txt = Modulo.require('fs').readFileSync('./src/Modulo.js', 'utf8');
            }
            return Modulo.require('sloc')(txt, 'js').source;
        }
        function checksum() {
            if (!txt) {
                txt = Modulo.require('fs').readFileSync('./src/Modulo.js', 'utf8');
            }
            const CryptoJS = Modulo.require("crypto-js");
            const hash = CryptoJS['SHA384'](txt);
            return hash.toString(CryptoJS.enc.Base64);
            //const shaObj = new jsSHA("SHA-384", "TEXT", { encoding: "UTF8" });

            //shaObj.update(txt);
            //const hash = shaObj.getHash("B64");
            //return hash;
        }

        function getVersionInfo() {
            // Only do once to speed up SSG
            //console.log('this is Modulo', Object.keys(Modulo));
            if (!Modulo.ssgStore.versionInfo) {
                const bytes = Modulo.require('fs').readFileSync('./package.json');
                const data = JSON.parse(bytes);
                Modulo.ssgStore.versionInfo = {
                    version: data.version,
                    sloc: sloccount(),
                    checksum: checksum(),
                };
            }
            return Modulo.ssgStore.versionInfo;
        }

        // https://stackoverflow.com/questions/400212/
        const {document, navigator} = Modulo.globals;
        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;

            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'successful' : 'unsuccessful';
                console.log('Fallback: Copying text command was ' + msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
        }
        function copyTextToClipboard(text) {
            if (!navigator.clipboard) {
                fallbackCopyTextToClipboard(text);
                return;
            }
            navigator.clipboard.writeText(text).then(function() {
                console.log('Async: Copying to clipboard was successful!');
            }, function(err) {
                console.error('Async: Could not copy text: ', err);
            });
        }
    </script>
</module>


<template mod-component="Navbar">
    <script type="modulo/template">
        <nav class="Navbar">
            <a href="/index.html"><img src="/img/mono_logo.png" style="height:70px" alt="Modulo" /></a>
            <ul>
                <li>
                    <a href="/index.html#below" {% if props.selected == "about" %}class="Navbar--selected"{% endif %}>About</a>
                </li>
                <li>
                    <a href="/start.html" {% if props.selected == "start" %}class="Navbar--selected"{% endif %}>Start</a>
                </li>
                <li>
                    <a href="/docs.html" {% if props.selected == "docs" %}class="Navbar--selected"{% endif %}>Docs</a>
                </li>
                <!--
                <li>
                    <a href="/literate/src/Modulo.html" {% if props.selected == "source" %}class="Navbar--selected"{% endif %}>Source</a>
                </li>
                -->
            </ul>

            <div class="Navbar-rightInfo">
                v: {{ script.exports.version }}<br />
                SLOC: {{ script.exports.sloc }} lines<br />
                <a href="https://github.com/michaelpb/modulo/">github</a> | 
                <a href="https://npmjs.com/michaelpb/modulo/">npm</a> 
            </div>
        </nav>
    </script>

    <props selected=""></props>

    <script>
        function initializedCallback() {
            if (Modulo.isBackend) {
                //Modulo.ssgStore.navbar = module.script.getVersionInfo();
                //Object.assign(script.exports, Modulo.ssgStore.navbar);
                const info = module.script.getVersionInfo();
                Object.assign(script.exports, info);
                // Store results in DOM for FE JS
                element.setAttribute('script-exports', JSON.stringify(script.exports));
            } else {
                // FE JS, retrieve from DOM
                const dataStr = element.getAttribute('script-exports');
                Object.assign(script.exports, JSON.parse(dataStr));
            }
        }
    </script>
</template>

<component name="Section">
    <props name=""></props>
    <template>
        <a class="secanchor" title="Click to focus on this section." id="{{ props.name }}" name="{{ props.name }}" href="#{{ props.name }}">#</a>
        <h2 [component.children]=""></h2>
    </template>
    <style>
        Section {
            position: relative;
        }
        h2 {
            font-weight: bold;
            color: var(--highlight-color);
            margin-bottom: 0;
        }
        a.secanchor {
            padding-top: 100px;
            color: var(--highlight-color);
            opacity: 0.3;
            display: block;
        }
        Section:hover .Section-helper {
            opacity: 1.0;
        }
    </style>
</component>

<template mod-component="TabSet">
    <template>
        <nav class="tab-nav">
            <ul>
                {% for tab in state.tabs %}
                    <li class="tab-nav_title
                        {% if tab.title == state.selected %}
                            tab-nav_title__selected
                        {% endif %}
                    "><a @click:="script.select" click.payload="{{ tab.title }}">{{ tab.title }}</a></li>
                {% endfor %}
            </ul>
        </nav>
        <div [component.children]="" modulo-ignore="">
        </div>
    </template>
    <style>
        TabSet {
            width: 100%;
            display: flex;
            flex-direction: column;
            /*border: 1px dotted var(--highlight-color);*/
            /*border-top: 1px dotted black;*/
        }
        .tab-nav {
            /*border-bottom: 1px dotted var(--highlight-color);*/
            width: 100%;
        }
        .tab-nav > ul {
            width: 100%;
            display: flex;
        }
        .tab-nav_title {
            border: 2px solid black;
            border-top-width: 4px;
            border-bottom-width: 0;
            border-radius: 8px 8px 0 0;
            background: white;
            min-width: 10%;
        }

        .tab-nav_title a,
        .tab-nav_title a:visited,
        .tab-nav_title a:active {
            text-decoration: none;
            color: black;
            display: block;
            padding: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .tab-nav_title__selected {
            background: var(--highlight-color);
            box-shadow: 0 0 0 5px var(--highlight-color);
            padding-top: 3px;
            border-top-width: 1px;
            border-radius: 1px;
        }
    </style>
    <state selected="" tabs:="[]"></state>
    <script>
        function initializedCallback() {
            state.tabs = [];

            for (const child of element.originalChildren) {
                if (child.nodeType !== 1) { // DOM Element
                    continue;
                }
                const title = child.getAttribute('name');
                if (!title) {
                    continue;
                }
                state.tabs.push({title, child});
            }

            if (state.tabs[0]) {
                state.selected = state.tabs[0].title;
                refreshTabs();
            }
        }

        function refreshTabs() {
            for (const {title, child} of state.tabs) {
                if (title === state.selected) {
                    child.style.display = 'block';
                    let editorToWake = child.querySelector('.CodeMirror');
                    if (editorToWake) {
                        editorToWake.CodeMirror.refresh();
                    }

                } else if (child.style) {
                    child.style.display = 'none';
                }
            }
        }

        function select(ev, payload) {
            //console.log('selection happening!', payload);
            state.selected = payload;
            refreshTabs();
        }
    </script>
</template>

<template mod-component="CodeExample">
    <template>
        <div class="split">
            <div style="height: {{ props.vsize|number|default:170|add:2 }}px;" modulo-ignore="">
                <textarea [script.codemirror]="">                </textarea>
            </div>

            <div>
                <div class="toolbar">
                    <h2>Preview</h2>
                    <button @click:="script.run">Run ‚ü≥</button>
                </div>
                <div [script.previewspot]="" class="preview-wrapper">
                    <div modulo-ignore=""></div>
                </div>
                {% if props.showtag %}
                    {% if props.preview %}
                        <div class="toolbar">
                            <h2>Tag</h2>
                            <code>{{ props.preview }}</code>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </template>

    <style>
        .toolbar {
            display: flex;
            justify-content: space-between;
        }
        .toolbar > button {
            border: 2px solid black;
            border-top-width: 1px;
            border-bottom-width: 3px;
            border-radius: 3px;
            background: white;
            font-weight: lighter;
            text-transform: uppercase;
        }
        .toolbar > button:active {
            border-top-width: 3px;
            border-bottom-width: 1px;
        }
        .toolbar > button:hover {
            box-shadow: 0 0 2px var(--highlight-color); /* extremely subtle shadow */
        }
        .split > div:last-child {
            padding: 5px;
            background: whiteSmoke;
        }
        .split > div:first-child{
            border: 1px solid black;
            /*overflow-y: scroll;*/
        }

        .preview-wrapper {
            margin-top: 4px;
            padding: 5px;
            padding-left: 20px;
            padding-right: 20px;
            border: 1px solid black;
        }

        .split > div > textarea {
            width: 100%;
            min-height: 10px;
        }
        .split {
            display: grid;
            grid-template-columns: 2fr 1fr;
        }
        @media (max-width: 992px) {
            .split { display: block; }
        }
    </style>

    <props text="" extraprops="" vsize="" textsrc="" cname=""></props>

    <state nscounter:="1" preview=""></state>
    <script>
        let egTexts = null;
        try {
            if ('eg-eg' in Modulo.factoryInstances) {
                egTexts = Modulo.factoryInstances['eg-eg']
                    .baseRenderObj.script.exports.componentTexts;
            }
        } catch {
            console.log('couldnt get egTexts');
        }

        let exCounter = 0; // global variable
        //console.log('gettin script tagged');
        /* Configure loader: */
        function initializedCallback() {
            //console.log('hey i am getting initialized wow');
            //console.log('initialized callback', element.innerHTML);
            if (Modulo.isBackend) {
                let html;
                if (egTexts && props.cname) {
                    Modulo.assert(props.cname in egTexts, `${props.cname} not found`);
                    html = egTexts[props.cname];
                } else {
                    html = (element.innerHTML || '').trim();
                    html = html.replace(/([\w\[\]\._-]+):="(\w+)"/, '$1:=$2'); // clean up due to DOM
                }

                if (props.textsrc) {
                    const html = Modulo.require('fs')
                        .readFileSync('./docs-src/' + props.textsrc, 'utf8');
                    element.setAttribute('text', html);
                } else if (html && !element.getAttribute('text')) {
                    element.setAttribute('text', html);
                }
            }
        }

        function previewspotMount({el}) {
            element.previewSpot = el.firstElementChild;
            run(); // mount after first render
        }

        function codemirrorMount({el}) {
            if (Modulo.globals.CodeMirror) {
                //console.log('this is props', props);
                // TODO: Debug this, should not use textarea, should not need
                // extra refreshes or anything
                const cm = CodeMirror.fromTextArea(el, {
                    lineNumbers: true,
                    mode: 'django',
                    theme: 'eclipse',
                    indentUnit: 4,
                });
                element.codeMirrorEditor = cm;
                window.cm = cm;

                const height = props.vsize ? Number(props.vsize) : 170;
                cm.setValue('');
                cm.setSize(null, height);
                cm.refresh();

                let text = props.text.trim();
                text = text.replace(/&#39;/g, "'"); // correct double escape
                cm.setValue(text);
                setTimeout(() => {
                    cm.setValue(text);
                    cm.setSize(null, height);
                    cm.refresh();
                }, 1);
                el.setAttribute('modulo-ignore', 'y');
            } else {
                //console.log('Code mirror not found'); // probably SSG
            }
        }

        function run() {
            if (!Modulo.globals.CodeMirror) {
                return;
            }
            exCounter++;
            //console.log('There are ', exCounter, ' examples on this page. Gee!')
            const namespace = `e${exCounter}g${state.nscounter}`; // TODO: later do hot reloading using same loader
            state.nscounter++;
            const loadOpts = {src: '', namespace};
            const loader = new Modulo.Loader(null, {options: loadOpts});
            const tagName = 'Example';
            let text = element.codeMirrorEditor.getValue();
            text = `<template mod-component="${tagName}">${text}</template>`;
            //console.log('Creating component from text:', text)
            loader.loadString(text);
            const tag = `${namespace}-${tagName}`;
            let extraPropsStr = '';
            /*
            const extraProps =  props.extraprops ? JSON.parse(props.extraprops) : {};
            for (const [key, value] of Object.entries(extraProps)) {
                const escValue = value.replace(/"/g, , '&quot;');
                extraPropsStr += ` ${key}="${escValue}"`;
            }
            */

            const preview = `<${tag}${extraPropsStr}></${tag}>`;
            element.previewSpot.innerHTML = preview;
            //state.preview = preview;
            //document.querySelector('#previewSpot').innerHTML = preview;
            //console.log('adding preview', preview);
        }
    </script>
</template>

<template mod-component="CodeSnippet">
    <template>
        <button class="m-Btn m-Btn--sm m-Btn--faded" title="Copy this code" @click:="script.doCopy">
            <span alt="Clipboard">üìã</span>
        </button>
        <div modulo-ignore="">
            <div [script.codemirror]=""></div>
        </div>
    </template>
    <props text=""></props>
    <style>
        CodeSnippet {
            position: relative;
            display: block;
        }
        .m-Btn {
            position: absolute;
            top: 1px;
            right: 1px;
            z-index: 10;
        }
    </style>
    <script>
        function doCopy() {
            module.script.copyTextToClipboard(props.text);
        }
        function codemirrorMount({el}) {
            let text = props.text.trim();
            if (Modulo.isBackend && text.includes('$modulojs_sha384_checksum$')) {
                const info = module.script.getVersionInfo();
                const checksum = info.checksum || '';
                text = text.replace('$modulojs_sha384_checksum$', checksum)
                element.setAttribute('text', text);
            }
            if (Modulo.globals.CodeMirror) {
                const cm = CodeMirror(el, {
                    //lineNumbers: true,
                    value: text,
                    mode: 'django',
                    theme: 'eclipse',
                    indentUnit: 4,
                    readOnly: true,
                });
                element.codeMirrorEditor = cm;
            }
        }
    </script>
</template>

<template mod-component="RouteIndex">
    <script>
        function initializedCallback() {
            const {isBackend, ssgCurrentSubPath, globals} = Modulo;
            const path = isBackend ? ssgCurrentSubPath : globals.location.hash;
            if (path) {
                element.innerHTML = '';
            }
        }
    </script>
</template>

<template mod-component="Route">
    <props name="" src="" index="" loadedcontent="" ssgpath=""></props>
    <script>
        function readFile(currentPath, src) {
            const path = Modulo.require('path');
            const fullPath = path.resolve(path.join(path.dirname(currentPath), src));
            //console.log('found this fullPath', fullPath, currentPath, src);
            return Modulo.require('fs').readFileSync(fullPath, 'utf8');
        }

        function getNewFilePath(newFilePath, name) {
            // Strip HTML extension
            if (newFilePath.toLowerCase().endsWith('.html')) {
                newFilePath = newFilePath.substr(0, newFilePath.length - 5);
            }

            let newBaseName = name.replace(/\//g, '__') + '.html'; // Sanitize for filename
            newFilePath = newFilePath + '/' + newBaseName;
            return newFilePath;
        }

        function setupBackend() {
            const {name, src} = props;
            const {ssgCurrentPath, ssgCurrentSubPath, ssgCurrentOutputPath} = Modulo;

            const key = `mdu-Router|${src}`;
            if (!Modulo.ssgStore[key]) {
                Modulo.ssgStore[key] = readFile(ssgCurrentPath, src);
            }

            if (ssgCurrentSubPath) {
                // We are currently "in" a subpath right now, fill with data
                const data = Modulo.ssgStore[key];
                if (ssgCurrentSubPath === ssgCurrentOutputPath &&
                        ssgCurrentSubPath.endsWith(name + '.html')) {
                    element.innerHTML = data;
                    //Modulo.defineAll();
                }
            } else {
                // otherwise, transform the path
                const newFilePath = getNewFilePath(ssgCurrentOutputPath, name);
                Modulo.ssgRegisterSubPath(newFilePath);
                element.setAttribute('ssgpath', newFilePath);
                if (props.index) {
                    element.innerHTML = Modulo.ssgStore[key];
                }
            }
        }

        function fetchCallback(html) {
            element.innerHTML = html;
        }

        function initializedCallback() {
            const {isBackend, globals} = Modulo;
            if (isBackend) {
                setupBackend();
            } else {
                const hash = globals.location.hash;
                const filename = `${props.name}.html`;
                if (hash && hash.startsWith('/')) {
                    if (hash === props.ssgpath) {
                        globals.location.url = props.ssgpath; // redirect
                    } else if (hash.endsWith(filename) || hash.endsWith(props.name)) {
                        Modulo.globals.fetch(props.src)
                            .then(response => response.text())
                            .then(fetchCallback);
                    }
                }
            }
            /*
            else {
                console.log('checkin props');
                if (props.loadedcontent) {
                    //console.log('settin inner html', props.loadedcontent);
                    //console.log(element);
                    //element.innerHTML = props.loadedcontent;
                    //element.setAttribute('loadedcontent', '');
                }
                //TODO: Check for hash-fragment navigation here
                // ALSO: If hash fragment is found, AND was processed by a SSG
                // (set "wasSSG=True"), then auto window.location.url redirect
            }
            */
        }
    </script>
</template>


</body>