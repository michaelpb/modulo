<Component name="MirrorEditor" rerender="manual">
    <Props
        value
        name
        spellcheck
        component
        debounce-time
    ></Props>
    <Template>
        <div class="editor-wrapper" @click:=script.updateDimensions>
            <div class="editor-underlay-container"
                style="
                    {% if state.width %}  width: {{ state.width }}px; {% endif %}
                    {% if state.height %} height: {{ state.height }}px; {% endif %}
                ">
                <div class="editor-underlay-offset-wrapper"
                    style="
                        {% if state.scrollTop %} top: -{{ state.scrollTop }}px; {% endif %}
                        {% if state.width %} width: {{ state.width }}px; {% endif %}
                    ">
                    <{{ props.component|default:"mdu-SyntaxHighlighter" }}
                        value="{{ state.value }}"
                    ></{{ props.component|default:"mdu-SyntaxHighlighter" }}>
                </div>
            </div>

            <textarea
                [script.text]
                @scroll:=script.updateDimensions
                data-gramm="false"
                name="{{ props.name|default:'editor' }}"
                spellcheck="{{ props.spellcheck|default:'false' }}"
            ></textarea>
        </div>
    </Template>

    <State
        selection-start:=0
        scroll-top:=0
        width:=0
        height:=0
        last=""
        editor-shadow-html=""
        value=""
    ></State>

    <Script src="./editor/MirrorEditor.js"></Script>

    <Style>
        :host {
            display: block;
            position: relative;
            min-height: 100px;
            min-width: 100px;

            /* Outline default is 50% gray, 90% opacity, so it should be
               passable for both "lightmode" and "darkmode" type designs */
            --outline-color: rgba(127, 127, 127, 0.9);
            --outline-width: 3px;
            --text-color: #151515;
        }
        .editor-wrapper {
            position: relative;
            height: 100%;
        }

        .syn-bold { font-weight: bold; }
        .syn-italic { font-style: italic; }
        .syn-header {
            font-weight: bold;
            background: black;
            color: white;
        }
        .syn-code {
            border-bottom: 1px dotted green;
            color: green;
        }
        .syn-link {
            text-decoration: underline;
            color: blue;
        }
        .syn-ol,
        .syn-ul,
        .syn-hr {
            color: green;
            font-weight: bold;
        }

        pre.editor-shadow,
        textarea {
            top: 0;
            left: 0;
            font-size: 16px;
            width: 100%;
            border: none;
            padding: 0;
            margin: 0;
            min-height: 1rem;
            height: 100%;
            font-family: monospace;
            text-align: start;
            resize: none;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            box-sizing: border-box;
            color: var(--text-color);
        }

        .editor-underlay-container {
            position: absolute;
            left: 0;
            overflow: hidden;
        }
        .editor-underlay-offset-wrapper {
            left: 0;
            position: absolute;
        }

        textarea {
            position: relative;
            background: none;
            /*color: rgba(0, 0, 0, 0.001);*/
            color: rgba(0, 0, 0, 0);
            caret-color: var(--text-color);
        }

        textarea:focus {
            outline: none !important;
            box-shadow: 0 0 0 var(--outline-width) var(--outline-color);
        }
    </Style>
</Component>

<Component name="SyntaxHighlighter">
    <Props
        value
    ></Props>

    <Script>
        const { escapeText } = Modulo.templating.MTL.prototype;
        const { safe } = Modulo.templating.defaultOptions.filters;
        function syntaxHighlight(text) {
            text = escapeText(text);
            //text = text.replace(/&quot;.*?&quot;/g, '<span class="syn-string">$&</span>');
            //text = text.replace(/&gt;.*?&lt;/g, '<span class="syn-tag">$&</span>');
            text = text.replace(/\*.*?\*/g, '<span class="syn-bold">$&</span>');
            text = text.replace(/_.*?_/g, '<span class="syn-italic">$&</span>');
            text = text.replace(/^#+.*?$/gm, '<span class="syn-header">$&</span>');
            text = text.replace(/^\s*[+*-] /gm, '<span class="syn-ul">$&</span>');
            text = text.replace(/^\s*\d+[\.:]? /gm, '<span class="syn-ol">$&</span>');
            text = text.replace(/^---+$/gm, '<span class="syn-hr">$&</span>');
            text = text.replace(/`.*?`/g, '<span class="syn-code">$&</span>');
            text = text.replace(/\!?\[.*?\]\(.*?\)/g, '<span class="syn-link">$&</span>');
            //return safe(text);
            return text;
        }

        function updateCallback(renderObj) {
            element.innerHTML = syntaxHighlight(props.value || element.originalHTML);
        }
    </Script>

    <Style>
        :host {
            font-size: 16px;
            min-height:  200px;
            font-family: monospace;
            text-align: start;
            resize: none;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            box-sizing: border-box;
        }

        .syn-bold { font-weight: bold; }
        .syn-italic { font-style: italic; }
        .syn-header {
            font-weight: bold;
            background: black;
            color: white;
        }
        .syn-code {
            border-bottom: 1px dotted green;
            color: green;
        }
        .syn-link {
            text-decoration: underline;
            color: blue;
        }
        .syn-ol,
        .syn-ul,
        .syn-hr {
            color: green;
            font-weight: bold;
        }
    </Style>

</Component>

